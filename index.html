<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-16x16-next.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="生命不息，学习不停">
<meta property="og:type" content="website">
<meta property="og:title" content="Wang的宝库">
<meta property="og:url" content="http://www.wcqwolflow.com/index.html">
<meta property="og:site_name" content="Wang的宝库">
<meta property="og:description" content="生命不息，学习不停">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Wang的宝库">
<meta name="twitter:description" content="生命不息，学习不停">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.wcqwolflow.com/"/>





  <title>Wang的宝库</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
	<a href="https://github.com/wcq19941215/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<a href="https://github.com/wcq19941215/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wang的宝库</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/" itemprop="url">《ORANGE-s-一个操作系统实现》输入输出系统（5-2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-06T10:11:03+08:00">
                2018-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/" class="cy_cmt_count" data-xid="2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-2）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》输入输出系统（5-2）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="显示器"><a href="#显示器" class="headerlink" title="显示器"></a>显示器</h1><h2 id="初识TTY"><a href="#初识TTY" class="headerlink" title="初识TTY"></a>初识TTY</h2><p>TTY在Linux中就是终端。当按下ALT+F1、ALT+F2、ALT+F3等组合键时，会切换到不同的屏幕。对于不同的TTY可以理解成下面：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/G5jE67714i.png?imageslim" alt="mark"><br>虽然不同的TTY对应的输入设备是同一个键盘，但是输出却好比是在不同的显示器上，因为不同的TTY对应的屏幕画面可能不同。实际上，画面的不同，仅仅是显示了显存的不同位置罢了。<br>既然3个CONSOLE公用一块显存，那就有一种方式在切换CONSOLE的瞬间，让屏幕显示显存中某个位置的内容。<br>屏幕上每一个字符对应的2字节的定义如下所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/hLcie7G3B1.png?imageslim" alt="mark"><br>可以看到，第字节表示的是字符本身，高字节用来定义字符的颜色。<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/5dE3e6j1eh.png?imageslim" alt="mark"></p>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><p>VGA视频子系统的寄存器如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/3CbB2AdK3d.png?imageslim" alt="mark"><br>这么多的寄存器，只有一个端口0X3D5，然后配合Address Register。下图中每一个寄存器都对应一个索引值，当想要访问其中一个的时候，只需要先向Adress Register写对应的索引值，然后在通过端口0x3D5进程的操作就是针对索引值对应的寄存器了。<br>![mark](<a href="http://p29pmm8g4.bkt.clouddn.com/blog/180306/6aKGfjHmCk" target="_blank" rel="noopener">http://p29pmm8g4.bkt.clouddn.com/blog/180306/6aKGfjHmCk</a><br>下面我们让光标跟随我们敲入的字符，设置光标位置：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">disable_int()<span class="comment">;</span></span><br><span class="line">		out_byte(<span class="name">CRTC_ADDR_REG</span>, CURSOR_H)<span class="comment">;</span></span><br><span class="line">		out_byte(<span class="name">CRTC_DATA_REG</span>, ((<span class="name">disp_pos/2</span>)&gt;&gt;8)&amp;0xFF)<span class="comment">;</span></span><br><span class="line">		out_byte(<span class="name">CRTC_ADDR_REG</span>, CURSOR_L)<span class="comment">;</span></span><br><span class="line">		out_byte(<span class="name">CRTC_DATA_REG</span>, (<span class="name">disp_pos/2</span>)&amp;0xFF)<span class="comment">;</span></span><br><span class="line">		enable_int()<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>make运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/CIjLKdgCL4.png?imageslim" alt="mark"><br>接着，我们通过设置Start Adressb High Register和Start Adress Low Register来重新设置显示开始地址，从而实现滚屏的功能。当我们按下shift+上箭头时，则卷动屏幕向上15行<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/BA0mclK9Af.png?imageslim" alt="mark"></p>
<h1 id="TTY任务"><a href="#TTY任务" class="headerlink" title="TTY任务"></a>TTY任务</h1><p>在TTY任务中执行一个循环，这个循环将轮询每一个TTY，处理它的事件，包括从键盘缓冲区读取数据、显示字符等。它的运行方式如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/eA02LFamg7.png?imageslim" alt="mark"><br>其实轮询到每一个TTY时，不外乎做两件事：</p>
<ul>
<li>处理输入：查看是不是当前TTY，如果是则从键盘缓冲区读取数据。</li>
<li>处理输出：如果有要显示的内容则显示它。<br>下面要做的TTY任务不再简单，主要表现为：</li>
<li>每一个TTY都应该有自己的读和写的动作。所以在keyboard_read（）内部，函数需要了解自己是被哪一个TTY调用。我们通过为函数传入一个参数来做到这一点，这个参数是指向当前TTY的指针。</li>
<li>为了让输入输出分离，被keyboard_read（）调用的in_process()不应该再直接回显示符，而应该将回显的任务交给TTY来完成，这样我们就需要为每个TTY建立一块缓冲区，用以放置将被回显的字符。</li>
<li>每个TTY回显字符时操作的console是不同的，所以每个TTY都应该有个成员来记载其对应的console信息。<h2 id="TTY任务框架的搭建"><a href="#TTY任务框架的搭建" class="headerlink" title="TTY任务框架的搭建"></a>TTY任务框架的搭建</h2>TTY结构如下：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TTY_IN_BYTES	256	<span class="comment">/* tty input queue size */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s_console</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TTY */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_tty</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	u32	in_buf[TTY_IN_BYTES];	<span class="comment">/* TTY 输入缓冲区 */</span></span><br><span class="line">	u32*	p_inbuf_head;		<span class="comment">/* 指向缓冲区中下一个空闲位置 */</span></span><br><span class="line">	u32*	p_inbuf_tail;		<span class="comment">/* 指向键盘任务应处理的键值 */</span></span><br><span class="line">	<span class="keyword">int</span>	inbuf_count;		<span class="comment">/* 缓冲区中已经填充了多少 */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">s_console</span> *	<span class="title">p_console</span>;</span></span><br><span class="line">&#125;TTY;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>CONSOLE结构如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_console</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	current_start_addr;	<span class="comment">/* 当前显示到了什么位置	  */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	original_addr;		<span class="comment">/* 当前控制台对应显存位置 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	v_mem_limit;		<span class="comment">/* 当前控制台占的显存大小 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	cursor;			<span class="comment">/* 当前光标位置 */</span></span><br><span class="line">&#125;CONSOLE;</span><br></pre></td></tr></table></figure></p>
<p>整个程序的流程如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/IgF8dC2JKI.png?imageslim" alt="mark"><br>在task_tty()中，通过循环来处理每一个TTY的读和写操作，读写操作都放在了tty_do_read()和tty_do_write()两个函数中，这样就让taske_tty()很简洁，而且逻辑清晰。读操作会调用keyboard_read()，当然此时已经多了一个参数；写操作会调用out_char()，它会将字符写入指定的CONSOLE。，当TTY任务开始运行时，所有TTY都将被初始化，并且全局变量nr_current_console会被赋值为0.然后循环开始并一直进行下去。对于每一个TTY，首先执行tty_do_read（），它将调用kerboard_read()并将读入的字符交给函数in_process（）来处理，如果是需要输出的字符，会被in_process（）放入当前接受处理的TTY的缓冲区中。然后tty_do_write()会接着执行，如果缓冲区中有数据，就被送入out_char显示出来。</p>
<h2 id="多控制台"><a href="#多控制台" class="headerlink" title="多控制台"></a>多控制台</h2><p>下面是多控制台示意图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/AJm32hJgLF.png?imageslim" alt="mark"><br>表示了某时刻显存的使用情况。其中灰色框表示当前屏幕，黑色小方格显示显存已经写入的字符。<br>运行结果如下:<br>在控制台0按下数次shift+箭头上<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/b1mfg6HcfA.png?imageslim" alt="mark"></p>
<h2 id="完善键盘处理"><a href="#完善键盘处理" class="headerlink" title="完善键盘处理"></a>完善键盘处理</h2><h3 id="回车键和退格键"><a href="#回车键和退格键" class="headerlink" title="回车键和退格键"></a>回车键和退格键</h3><p>当敲击回车键和退格键时，我们王TTY缓冲区中写入“\n”和“\b”，然后在out_char中做出相应的处理，如下：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUBLIC</span> void in_process(TTY* p_tty, u32 key)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">char</span> output[<span class="number">2</span>] = &#123;<span class="string">'\0'</span>, <span class="string">'\0'</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(key &amp; FLAG_EXT)) &#123;</span><br><span class="line">		put_key(p_tty, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> raw_code = key &amp; MASK_RAW;</span><br><span class="line">                <span class="keyword">switch</span>(raw_code) &#123;</span><br><span class="line">                <span class="keyword">case</span> ENTER:</span><br><span class="line">			put_key(p_tty, <span class="string">'\n'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">			put_key(p_tty, <span class="string">'\b'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">。。。。。。</span><br><span class="line"><span class="keyword">PRIVATE</span> void put_key(TTY* p_tty, u32 key)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (p_tty-&gt;inbuf_count &lt; TTY_IN_BYTES) &#123;</span><br><span class="line">		*(p_tty-&gt;p_inbuf_head) = key;</span><br><span class="line">		p_tty-&gt;p_inbuf_head++;</span><br><span class="line">		<span class="keyword">if</span> (p_tty-&gt;p_inbuf_head == p_tty-&gt;in_buf + TTY_IN_BYTES) &#123;</span><br><span class="line">			p_tty-&gt;p_inbuf_head = p_tty-&gt;in_buf;</span><br><span class="line">		&#125;</span><br><span class="line">		p_tty-&gt;inbuf_count++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后修改out_char：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC void out_char(CONSOLE* p_con, char ch)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="title">u8</span>* p_vmem = (u8*)(V_MEM_BASE + p_con-&gt;</span>cursor * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	switch(ch) &#123;</span><br><span class="line">	case <span class="string">'\n'</span>:</span><br><span class="line">		<span class="function"><span class="title">if</span> (p_con-&gt;</span><span class="function"><span class="title">cursor</span> &lt; p_con-&gt;</span>original_addr +</span><br><span class="line">		    <span class="function"><span class="title">p_con</span>-&gt;</span>v_mem_limit - SCREEN_WIDTH) &#123;</span><br><span class="line">			<span class="function"><span class="title">p_con</span>-&gt;</span><span class="function"><span class="title">cursor</span> = p_con-&gt;</span>original_addr + SCREEN_WIDTH * </span><br><span class="line">				((<span class="function"><span class="title">p_con</span>-&gt;</span><span class="function"><span class="title">cursor</span> - p_con-&gt;</span>original_addr) /</span><br><span class="line">				 SCREEN_WIDTH + <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	case <span class="string">'\b'</span>:</span><br><span class="line">		<span class="function"><span class="title">if</span> (p_con-&gt;</span><span class="function"><span class="title">cursor</span> &gt; p_con-&gt;</span>original_addr) &#123;</span><br><span class="line">			<span class="function"><span class="title">p_con</span>-&gt;</span>cursor--;</span><br><span class="line">			*(p_vmem-<span class="number">2</span>) = <span class="string">' '</span>;</span><br><span class="line">			*(p_vmem-<span class="number">1</span>) = DEFAULT_CHAR_COLOR;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	default:</span><br><span class="line">		<span class="function"><span class="title">if</span> (p_con-&gt;</span>cursor &lt;</span><br><span class="line">		    <span class="function"><span class="title">p_con</span>-&gt;</span><span class="function"><span class="title">original_addr</span> + p_con-&gt;</span>v_mem_limit - <span class="number">1</span>) &#123;</span><br><span class="line">			*p_vmem++ = ch;</span><br><span class="line">			*p_vmem++ = DEFAULT_CHAR_COLOR;</span><br><span class="line">			<span class="function"><span class="title">p_con</span>-&gt;</span>cursor++;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">while</span> (p_con-&gt;</span><span class="function"><span class="title">cursor</span> &gt;= p_con-&gt;</span>current_start_addr + SCREEN_SIZE) &#123;</span><br><span class="line">		scroll_screen(p_con, SCR_DN);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flush(p_con);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================================================================*</span></span><br><span class="line"><span class="comment">                           flush</span></span><br><span class="line"><span class="comment">*======================================================================*/</span></span><br><span class="line">PRIVATE void flush(CONSOLE* p_con)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="function"><span class="title">set_cursor</span>(p_con-&gt;</span>cursor);</span><br><span class="line">        <span class="function"><span class="title">set_video_start_addr</span>(p_con-&gt;</span>current_start_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到回车键直接把光标挪到了下一行的开头，而退格键则把光标挪到上一个字符的位置，并在那里写一个空格，以便清除原来的字符。<br>由于不断的回车会让光标快速的移动到屏幕的底端。所以在这里还要判断光标是否已经移出了屏幕，如果是的话将会触发屏幕滚动。<br>另外，输出的任何类型的字符时，都做了边界检验，以防止影响到别的控制台，甚至试图写到显存之外的内存。<br>运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/FkeaLFCf41.png?imageslim" alt="mark"></p>
<h1 id="区分任务和用户进程"><a href="#区分任务和用户进程" class="headerlink" title="区分任务和用户进程"></a>区分任务和用户进程</h1><p>前面的TTY我们称之为任务，A、B、C则为用户进程。在具体的实现上，让用户进程运行在ring3，任务继续留在ring1。如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/jfAk5EdG4E.png?imageslim" alt="mark"></p>
<h1 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h1><h2 id="为进程指定TTY"><a href="#为进程指定TTY" class="headerlink" title="为进程指定TTY"></a>为进程指定TTY</h2><p>当某个进程调用printf时，操作系统必须知道往哪个控制台输出才行。而当系统调用发生,ring3跳入ring0时，系统只能知道当前系统调用是由哪个进程触发的。所以我们必须为每个进程指定一个与之相对应的TTY，这可以通过在进程表中增加一个成员来实现。</p>
<h2 id="printf（）的实现"><a href="#printf（）的实现" class="headerlink" title="printf（）的实现"></a>printf（）的实现</h2><p>printf()的实现并不简单，首先是它的参数个数和类型都可变，而且其表示格式的参数形式多样，在printf()中。都要加以识别。<br>下面我们先实现printf（）只支持%X一种格式。如下：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> printf(const <span class="built_in">char</span> *<span class="keyword">fmt</span>,...)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> i;</span><br><span class="line">    <span class="built_in">char</span> buf[<span class="number">256</span>];</span><br><span class="line">    va_list arg=(va_list)((<span class="built_in">char</span>*)(&amp;<span class="keyword">fmt</span>)+<span class="number">4</span>);</span><br><span class="line">    i=vsprintf(buf,<span class="keyword">fmt</span>,arg);</span><br><span class="line">    <span class="built_in">write</span>(buf,i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h2><p>增加一个系统调用的过程如下所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/K034Hb39cd.png?imageslim" alt="mark"></p>
<h2 id="使用print分（）"><a href="#使用print分（）" class="headerlink" title="使用print分（）"></a>使用print分（）</h2><p>make运行结果如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/GgE795K4E4.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/" itemprop="url">《ORANGE-s-一个操作系统实现》输入输出系统（5-1）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-06T10:10:52+08:00">
                2018-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/" class="cy_cmt_count" data-xid="2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/03/06/《ORANGE-s-一个操作系统实现》输入输出系统（5-1）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》输入输出系统（5-1）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="键盘"><a href="#键盘" class="headerlink" title="键盘"></a>键盘</h1><p>操作系统需要交互，首先就是键盘</p>
<h2 id="从中断开始：键盘的初体验"><a href="#从中断开始：键盘的初体验" class="headerlink" title="从中断开始：键盘的初体验"></a>从中断开始：键盘的初体验</h2><p>因为8259A的IRQ1就是键盘，现在我们写一个键盘的处理程序：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">void</span> <span class="title">keyboard_handler</span><span class="params">(<span class="keyword">int</span> irq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    disp_str(<span class="string">"*"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个结果就是每按一次键盘，就会打印一个星号。<br>然后添加中断处理程序，并打开键盘中断：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">PUBLIC</span> <span class="selector-tag">void</span> <span class="selector-tag">init_keyboard</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">put_irq_handler</span>(KEYBOARD_IRD,keyboard_handler);<span class="comment">/*设定键盘中断程序*/</span></span><br><span class="line">    <span class="selector-tag">enable_irq</span>(KEYBOARD_IRQ);<span class="comment">/*开键盘中断*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在proto.h中声明init_keyboard()并调用它。<br>make之后，运行结果如下。<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/gChGbh378K.png?imageslim" alt="mark"><br>然后问题出现了，按了一次以后就没法再按出星号了。</p>
<h2 id="AT、PS-2键盘"><a href="#AT、PS-2键盘" class="headerlink" title="AT、PS/2键盘"></a>AT、PS/2键盘</h2><p>下图左边是PS/2键盘的接口，右边是AT键盘的接口，现在主流的都是USB的了。<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/gIeCdjfFDb.png?imageslim" alt="mark"></p>
<h2 id="键盘敲击的过程"><a href="#键盘敲击的过程" class="headerlink" title="键盘敲击的过程"></a>键盘敲击的过程</h2><p>在键盘中存在一个叫做键盘编码器的芯片，它通常是Intel 8048以及兼容芯片，作用是监视键盘的输入，并把适当的数据传送给计算机。另外在计算机主板上还有一个键盘控制器，用来接受和解码来自键盘的数据，并与8259A以及软件等进行通信。如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/971LKKd47A.png?imageslim" alt="mark"><br>敲击键盘有两个方面的含义：动作和内容。动作有三类:按下、保持按下以及放开；内容则是键盘上的不同的键.8048既要反应“哪个”安检产生动作，还要反映产生了什么内容。<br>敲击键盘产生的编码被称为扫描码，当一个键被按下或者保持按下时，将会产生Make Code，当弹起时，产生Break Code。当8048检测到一个键的动作，会把相应的扫描码发送给8042，8042会把它转换成相应的扫描码，并将其放置在缓冲区，然后8042告诉8259A产生中断（IRQ1）。如果此时键盘又有新的键被按下，8042将不再接受，一直到缓冲区被清空。<br>所以我们只能按下一次就没有反应了，因为缓冲区的内容没有被取走。<br>为了了解如何从缓冲区中读取扫描码，我们要学习8042：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/cGCLhfbcFe.png?imageslim" alt="mark"><br>对于输入和输出缓冲区，可以用in和out指令来进行相应的读取操作。如下，在keyboard_handler中添加：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_byte(<span class="number">0</span>x60)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/bE4IHjKLEE.png?imageslim" alt="mark"><br>我们发现结果是16进制数，所以我们用如下表格建立对应关系，即可看到想要的结果了：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/DHI5dH5C4c.png?imageslim" alt="mark"><br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/aCG2dIBbCC.png?imageslim" alt="mark"></p>
<h2 id="用数组表示扫描码"><a href="#用数组表示扫描码" class="headerlink" title="用数组表示扫描码"></a>用数组表示扫描码</h2><p>扫描码是一些数字，我们建立一个数组，以扫描码为下标，对应的元素就是相应的字符。数组是3个值一组，三个值是单独按某键、Shift+某键和有0xE0前缀扫描码对应的字符。Esc、Enter被定义成不冲突的宏即可：<br><figure class="highlight ruleslanguage"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">u32 keymap[NR_SCAN_CODES * MAP_COLS] = &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* scan-code			!Shift		Shift		E0 XX	*/</span></span><br><span class="line"><span class="comment">/* ==================================================================== */</span></span><br><span class="line"><span class="comment">/* 0x00 - none		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x01 - ESC		*/</span>	ESC,		ESC,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x02 - '1'		*/</span>	<span class="string">'1'</span>,		<span class="string">'!'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x03 - '2'		*/</span>	<span class="string">'2'</span>,		<span class="string">'@'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x04 - '3'		*/</span>	<span class="string">'3'</span>,		<span class="string">'#'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x05 - '4'		*/</span>	<span class="string">'4'</span>,		<span class="string">'$'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x06 - '5'		*/</span>	<span class="string">'5'</span>,		<span class="string">'%'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x07 - '6'		*/</span>	<span class="string">'6'</span>,		<span class="string">'^'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x08 - '7'		*/</span>	<span class="string">'7'</span>,		<span class="string">'&amp;'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x09 - '8'		*/</span>	<span class="string">'8'</span>,		<span class="string">'*'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0A - '9'		*/</span>	<span class="string">'9'</span>,		<span class="string">'('</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0B - '0'		*/</span>	<span class="string">'0'</span>,		<span class="string">')'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0C - '-'		*/</span>	<span class="string">'-'</span>,		<span class="string">'_'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0D - '='		*/</span>	<span class="string">'='</span>,		<span class="string">'+'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0E - BS		*/</span>	BACKSPACE,	BACKSPACE,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x0F - TAB		*/</span>	TAB,		TAB,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x10 - 'q'		*/</span>	<span class="string">'q'</span>,		<span class="string">'Q'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x11 - 'w'		*/</span>	<span class="string">'w'</span>,		<span class="string">'W'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x12 - 'e'		*/</span>	<span class="string">'e'</span>,		<span class="string">'E'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x13 - 'r'		*/</span>	<span class="string">'r'</span>,		<span class="string">'R'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x14 - 't'		*/</span>	<span class="string">'t'</span>,		<span class="string">'T'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x15 - 'y'		*/</span>	<span class="string">'y'</span>,		<span class="string">'Y'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x16 - 'u'		*/</span>	<span class="string">'u'</span>,		<span class="string">'U'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x17 - 'i'		*/</span>	<span class="string">'i'</span>,		<span class="string">'I'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x18 - 'o'		*/</span>	<span class="string">'o'</span>,		<span class="string">'O'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x19 - 'p'		*/</span>	<span class="string">'p'</span>,		<span class="string">'P'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x1A - '['		*/</span>	<span class="string">'['</span>,		<span class="string">'&#123;'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x1B - ']'		*/</span>	<span class="string">']'</span>,		<span class="string">'&#125;'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x1C - CR/LF		*/</span>	ENTER,		ENTER,		PAD_ENTER,</span><br><span class="line"><span class="comment">/* 0x1D - l. Ctrl	*/</span>	CTRL_L,		CTRL_L,		CTRL_R,</span><br><span class="line"><span class="comment">/* 0x1E - 'a'		*/</span>	<span class="string">'a'</span>,		<span class="string">'A'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x1F - 's'		*/</span>	<span class="string">'s'</span>,		<span class="string">'S'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x20 - 'd'		*/</span>	<span class="string">'d'</span>,		<span class="string">'D'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x21 - 'f'		*/</span>	<span class="string">'f'</span>,		<span class="string">'F'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x22 - 'g'		*/</span>	<span class="string">'g'</span>,		<span class="string">'G'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x23 - 'h'		*/</span>	<span class="string">'h'</span>,		<span class="string">'H'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x24 - 'j'		*/</span>	<span class="string">'j'</span>,		<span class="string">'J'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x25 - 'k'		*/</span>	<span class="string">'k'</span>,		<span class="string">'K'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x26 - 'l'		*/</span>	<span class="string">'l'</span>,		<span class="string">'L'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x27 - ';'		*/</span>	<span class="string">';'</span>,		<span class="string">':'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x28 - '\''		*/</span>	<span class="string">'\''</span>,		<span class="string">'"'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x29 - '`'		*/</span>	<span class="string">'`'</span>,		<span class="string">'~'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2A - l. SHIFT	*/</span>	SHIFT_L,	SHIFT_L,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2B - '\'		*/</span>	<span class="string">'\\'</span>,		<span class="string">'|'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2C - 'z'		*/</span>	<span class="string">'z'</span>,		<span class="string">'Z'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2D - 'x'		*/</span>	<span class="string">'x'</span>,		<span class="string">'X'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2E - 'c'		*/</span>	<span class="string">'c'</span>,		<span class="string">'C'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x2F - 'v'		*/</span>	<span class="string">'v'</span>,		<span class="string">'V'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x30 - 'b'		*/</span>	<span class="string">'b'</span>,		<span class="string">'B'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x31 - 'n'		*/</span>	<span class="string">'n'</span>,		<span class="string">'N'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x32 - 'm'		*/</span>	<span class="string">'m'</span>,		<span class="string">'M'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x33 - ','		*/</span>	<span class="string">','</span>,		<span class="string">'&lt;'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x34 - '.'		*/</span>	<span class="string">'.'</span>,		<span class="string">'&gt;'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x35 - '/'		*/</span>	<span class="string">'/'</span>,		<span class="string">'?'</span>,		PAD_SLASH,</span><br><span class="line"><span class="comment">/* 0x36 - r. SHIFT	*/</span>	SHIFT_R,	SHIFT_R,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x37 - '*'		*/</span>	<span class="string">'*'</span>,		<span class="string">'*'</span>,    	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x38 - ALT		*/</span>	ALT_L,		ALT_L,  	ALT_R,</span><br><span class="line"><span class="comment">/* 0x39 - ' '		*/</span>	<span class="string">' '</span>,		<span class="string">' '</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3A - CapsLock	*/</span>	CAPS_LOCK,	CAPS_LOCK,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3B - F1		*/</span>	F1,		F1,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3C - F2		*/</span>	F2,		F2,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3D - F3		*/</span>	F3,		F3,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3E - F4		*/</span>	F4,		F4,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x3F - F5		*/</span>	F5,		F5,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x40 - F6		*/</span>	F6,		F6,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x41 - F7		*/</span>	F7,		F7,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x42 - F8		*/</span>	F8,		F8,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x43 - F9		*/</span>	F9,		F9,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x44 - F10		*/</span>	F10,		F10,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x45 - NumLock	*/</span>	NUM_LOCK,	NUM_LOCK,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x46 - ScrLock	*/</span>	SCROLL_LOCK,	SCROLL_LOCK,	<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x47 - Home		*/</span>	PAD_HOME,	<span class="string">'7'</span>,		HOME,</span><br><span class="line"><span class="comment">/* 0x48 - CurUp		*/</span>	PAD_UP,		<span class="string">'8'</span>,		UP,</span><br><span class="line"><span class="comment">/* 0x49 - PgUp		*/</span>	PAD_PAGEUP,	<span class="string">'9'</span>,		PAGEUP,</span><br><span class="line"><span class="comment">/* 0x4A - '-'		*/</span>	PAD_MINUS,	<span class="string">'-'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x4B - Left		*/</span>	PAD_LEFT,	<span class="string">'4'</span>,		<span class="keyword">LEFT</span>,</span><br><span class="line"><span class="comment">/* 0x4C - MID		*/</span>	PAD_MID,	<span class="string">'5'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x4D - Right		*/</span>	PAD_RIGHT,	<span class="string">'6'</span>,		<span class="keyword">RIGHT</span>,</span><br><span class="line"><span class="comment">/* 0x4E - '+'		*/</span>	PAD_PLUS,	<span class="string">'+'</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x4F - End		*/</span>	PAD_END,	<span class="string">'1'</span>,		<span class="keyword">END</span>,</span><br><span class="line"><span class="comment">/* 0x50 - Down		*/</span>	PAD_DOWN,	<span class="string">'2'</span>,		DOWN,</span><br><span class="line"><span class="comment">/* 0x51 - PgDown	*/</span>	PAD_PAGEDOWN,	<span class="string">'3'</span>,		PAGEDOWN,</span><br><span class="line"><span class="comment">/* 0x52 - Insert	*/</span>	PAD_INS,	<span class="string">'0'</span>,		INSERT,</span><br><span class="line"><span class="comment">/* 0x53 - Delete	*/</span>	PAD_DOT,	<span class="string">'.'</span>,		<span class="keyword">DELETE</span>,</span><br><span class="line"><span class="comment">/* 0x54 - Enter		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x55 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x56 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x57 - F11		*/</span>	F11,		F11,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x58 - F12		*/</span>	F12,		F12,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x59 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x5A - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x5B - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		GUI_L,	</span><br><span class="line"><span class="comment">/* 0x5C - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		GUI_R,	</span><br><span class="line"><span class="comment">/* 0x5D - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		APPS,	</span><br><span class="line"><span class="comment">/* 0x5E - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x5F - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x60 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x61 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x62 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x63 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x64 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x65 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x66 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x67 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x68 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x69 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6A - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6B - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6C - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6D - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6E - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x6F - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x70 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x71 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x72 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x73 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x74 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x75 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x76 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x77 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x78 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x78 - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x7A - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x7B - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x7C - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x7D - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,	</span><br><span class="line"><span class="comment">/* 0x7E - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 0x7F - ???		*/</span>	<span class="number">0</span>,		<span class="number">0</span>,		<span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="键盘输入缓冲区"><a href="#键盘输入缓冲区" class="headerlink" title="键盘输入缓冲区"></a>键盘输入缓冲区</h2><p>这个是用来放置中断例程接受到的扫描码。为了解决当扫描码不止一个字符时的问题。<br>它的用法如图所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/I04cE2C65A.png?imageslim" alt="mark"><br>白色框表示空闲字节，灰色框表示已用字节。</p>
<h2 id="用新加的任务处理键盘操作"><a href="#用新加的任务处理键盘操作" class="headerlink" title="用新加的任务处理键盘操作"></a>用新加的任务处理键盘操作</h2><p>终端任务是要处理屏幕输出等内容的，为了简化我们现在只是不停的调用keyboard_read()：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC void task_tty<span class="comment">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span><span class="comment">(1)</span>&#123;</span><br><span class="line">        keyboard_read<span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>keyboard_read()首先判断kb_in.count是否为0，如果不为0表明缓冲区中有扫描码，就开始读取。</p>
<h2 id="解析扫描码"><a href="#解析扫描码" class="headerlink" title="解析扫描码"></a>解析扫描码</h2><h3 id="显示字符"><a href="#显示字符" class="headerlink" title="显示字符"></a>显示字符</h3><p>因为键盘的键的功能是不一样的，有的是一种功能不是一个ASCII。我们先处理可以打印的<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC void keyboard_read()</span><br><span class="line">&#123;</span><br><span class="line">	u8	<span class="keyword">scan_code;</span></span><br><span class="line"><span class="keyword">	</span>char	output[<span class="number">2</span>]<span class="comment">;</span></span><br><span class="line">	int	make<span class="comment">;	/* TRUE: make;  FALSE: break. */</span></span><br><span class="line"></span><br><span class="line">	memset(output, <span class="number">0</span>, <span class="number">2</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">	if(kb_in.count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">disable_int();</span></span><br><span class="line"><span class="keyword">	</span>	<span class="keyword">scan_code </span>= *(kb_in.p_tail)<span class="comment">;</span></span><br><span class="line">		kb_in.p_tail++<span class="comment">;</span></span><br><span class="line">		if (kb_in.p_tail == kb_in.<span class="keyword">buf </span>+ KB_IN_BYTES) &#123;</span><br><span class="line">			kb_in.p_tail = kb_in.<span class="keyword">buf;</span></span><br><span class="line"><span class="keyword">	</span>	&#125;</span><br><span class="line">		kb_in.count--<span class="comment">;</span></span><br><span class="line">		enable_int()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 下面开始解析扫描码 */</span></span><br><span class="line">		if (<span class="keyword">scan_code </span>== <span class="number">0xE1</span>) &#123;</span><br><span class="line">			<span class="comment">/* 暂时不做任何操作 */</span></span><br><span class="line">		&#125;</span><br><span class="line">		else if (<span class="keyword">scan_code </span>== <span class="number">0xE0</span>) &#123;</span><br><span class="line">			<span class="comment">/* 暂时不做任何操作 */</span></span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;	<span class="comment">/* 下面处理可打印字符 */</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 首先判断Make Code 还是 Break Code */</span></span><br><span class="line">			make = (<span class="keyword">scan_code </span>&amp; FLAG_BREAK ? FALSE : TRUE)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 如果是Make Code 就打印，是 Break Code 则不做处理 */</span></span><br><span class="line">			if(make) &#123;</span><br><span class="line">				output[<span class="number">0</span>] = keymap[(<span class="keyword">scan_code&amp;0x7F)*MAP_COLS];</span></span><br><span class="line"><span class="keyword">	</span>			<span class="keyword">disp_str(output);</span></span><br><span class="line"><span class="keyword">	</span>		&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* disp_int(scan_code); */</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的总体思想是0xE0和0xE1单独处理，其余都是单字节的，运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/Fj85fFJBLC.png?imageslim" alt="mark"></p>
<h3 id="处理shift、alt、ctrl"><a href="#处理shift、alt、ctrl" class="headerlink" title="处理shift、alt、ctrl"></a>处理shift、alt、ctrl</h3><p>先对这三个按键的状态进行判断，因为有左右之分，所以有6个键，当按下shift_l时，相应的变量就变为TRUE,如果立即释放则变为FALSE。如果if(shift_l||shift_r)成立，则表示左shift被按下且未被释放，此时colum值变为1。<br>运行一下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/AKF3268ahI.png?imageslim" alt="mark"><br>对于其他功能键，我们统一放在in_process()中，并在不可打印的字符的定义中，都加一个FLAG_EXT。运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180306/mfigfdIkE7.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/" itemprop="url">《ORANGE-s-一个操作系统实现》进程（4-2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T11:44:50+08:00">
                2018-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/" class="cy_cmt_count" data-xid="2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-2）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》进程（4-2）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h1><p>前面我们完成了ring0到ring1的跳转，它可以随时被中断，可以在中断处理程序完成之后被恢复。进程此时已经有了两种状态：运行和睡眠。接着我们只需要让其中一个进程处在运行状态，其余进程处在睡眠状态即可。</p>
<h2 id="添加一个进程体"><a href="#添加一个进程体" class="headerlink" title="添加一个进程体"></a>添加一个进程体</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i =<span class="number">0x1000</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        disp_str(<span class="string">"B"</span>);</span><br><span class="line">        disp_int(i++);</span><br><span class="line">        disp_str(<span class="string">"."</span>);</span><br><span class="line">        delay(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="进程表初始化代码扩充"><a href="#进程表初始化代码扩充" class="headerlink" title="进程表初始化代码扩充"></a>进程表初始化代码扩充</h2><p>进程之间的区别真的不大。每一次循环的不同在于，从TASK结构中读取不同的任务入口地址\堆栈栈顶和进程名，然后赋给相应的进程表项。需要注意以下两点：</p>
<ul>
<li>由于堆栈是从高地址到低地址生长的，所以在给每一个进程分配堆栈空间的时候，也是从高地址往低地址进行。</li>
<li>每一个进程都在GDT中分配一个描述符用来对应进程的LDT。<h2 id="LDT"><a href="#LDT" class="headerlink" title="LDT"></a>LDT</h2>因为每一个进程都会在GDT中对应一个LDT描述符。于是在for循环中，我们将每个进程表项中的成员p_proc-&gt;ldt_sel赋值。下面是初始化LDT：<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int i<span class="comment">;</span></span><br><span class="line">	PROCESS* p_proc	= proc_table<span class="comment">;</span></span><br><span class="line">	u16 selector_ldt = INDEX_LDT_FIRST &lt;&lt; <span class="number">3</span><span class="comment">;</span></span><br><span class="line">	for(i=<span class="number">0</span><span class="comment">;i&lt;NR_TASKS;i++)&#123;</span></span><br><span class="line">		init_descriptor(&amp;gdt[selector_ldt&gt;&gt;<span class="number">3</span>],</span><br><span class="line">				vir2phys(seg2phys(SELECTOR_KERNEL_DS),</span><br><span class="line">					proc_table[i].ldts),</span><br><span class="line">				LDT_SIZE * sizeof(DESCRIPTOR) - <span class="number">1</span>,</span><br><span class="line">				DA_LDT)<span class="comment">;</span></span><br><span class="line">		p_proc++<span class="comment">;</span></span><br><span class="line">		selector_ldt += <span class="number">1</span> &lt;&lt; <span class="number">3</span><span class="comment">;</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="修改中断程序"><a href="#修改中断程序" class="headerlink" title="修改中断程序"></a>修改中断程序</h2><p>一个进程由sleep状态变为run状态，无非是将esp指向进程表项的开始处，然后在执行lldt之后精力一系列pop指令恢复各个寄存器的值。一切信息都包含在进程表中，所以，要想恢复不同的进程，只需要将esp指向不同的进程表就可以了。<br>在离开内核栈的时候，执行如下语句：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,[p_proc_ready]</span><br></pre></td></tr></table></figure></p>
<p>全局变量p_proc_ready是指向进程表结构的指针，我们只需要在这一句执行之前把它赋予不同的值就可以了。<br>因为这部分即关于时钟中断，又关与进程调度。所以我们可以创建一个clock.c，也可以创建一个proc.c。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">void</span> <span class="title">clock_handler</span><span class="params">(<span class="keyword">int</span> irq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    disp_str(<span class="string">"#"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>make之后，结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/H51aAdE348.png?imageslim" alt="mark"><br>接着进行进程切换：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">void</span> <span class="title">clock_handler</span><span class="params">(<span class="keyword">int</span> irq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	disp_str(<span class="string">"#"</span>);</span><br><span class="line">	p_proc_ready++;</span><br><span class="line">	<span class="keyword">if</span> (p_proc_ready &gt;= proc_table + NR_TASKS)</span><br><span class="line">		p_proc_ready = proc_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一次我们让p_proc_ready指向进程表中的下一个表项，如果切换前已经到达进程表结尾则回到第一个表项。然后再make：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/gLFAfE6Cji.png?imageslim" alt="mark"><br>可以看到A和B交替出现。这说明第二个进程运行成。</p>
<h1 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h1><p>系统调用和API类似，当应用程序很多事做不了的时候，只能交给操作系统来做。所以一个事情，可能应用程序做了一部分，操作系统做一部分，这就涉及到特权级的问题了。<br>下面是本操作系统的运行过程：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/hl0CfKkie2.png?imageslim" alt="mark"></p>
<h2 id="实现一个简单的系统调用"><a href="#实现一个简单的系统调用" class="headerlink" title="实现一个简单的系统调用"></a>实现一个简单的系统调用</h2><p>我们通过实现get_tick()得到当前总共发生多少次时钟中断。设置一个全局变量ticks，每次发生一次时钟中断，它就加1.进程可以随时通过get_tick()这个系统调用来得到这个值。代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%include</span> <span class="string">"sconst.inc"</span></span><br><span class="line"></span><br><span class="line">_NR_get_ticks       <span class="built_in">equ</span> <span class="number">0</span> <span class="comment">; 要跟 global.c 中 sys_call_table 的定义相对应！</span></span><br><span class="line">INT_VECTOR_SYS_CALL <span class="built_in">equ</span> <span class="number">0x90</span></span><br><span class="line"></span><br><span class="line"><span class="meta">global</span>	get_ticks <span class="comment">; 导出符号</span></span><br><span class="line"></span><br><span class="line"><span class="meta">bits</span> <span class="number">32</span></span><br><span class="line">[<span class="meta">section</span> .text]</span><br><span class="line"></span><br><span class="line"><span class="symbol">get_ticks:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, _NR_get_ticks</span><br><span class="line">	<span class="keyword">int</span>	INT_VECTOR_SYS_CALL</span><br><span class="line">	<span class="keyword">ret</span></span><br></pre></td></tr></table></figure></p>
<h2 id="get-ticks的应用"><a href="#get-ticks的应用" class="headerlink" title="get_ticks的应用"></a>get_ticks的应用</h2><p>因为时钟中断发生的时间间隔是一定的，如果我们知道这个实践间隔，就可以用get_ticks函数来写一个判断时间的函数，进而代替delay()</p>
<h3 id="8253-8254-PIT"><a href="#8253-8254-PIT" class="headerlink" title="8253/8254 PIT"></a>8253/8254 PIT</h3><p>中断的发生实际上是由一个被称为PIT（Programmable Interval Timer）的芯片来触发的。在AT以及以后又Intel 8253换为Intel 8254。<br>8253有三个计数器：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/Kl8lbk2jEg.png?imageslim" alt="mark"><br>从上可知，中断实际是由8253的Counter0产生的。<br>计数器有一个输入频率，在PC上是1193180Hz，在每一个时钟周期，计数器值会减1，当减到0就会触发一个输出。由于计数器是16位的，所以最大值是65535，因此，默认的时钟中断的发生频率是1193180/65536~18.2Hz。<br>我们可以通过编程来控制8253.比如，想让系统每10ms产生一次中断，也就是让输出频率为100Hz，那么需要为计数器赋值为1193180/100~11932.<br>因为控制8253是通过端口的写操作完成的。如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/a83d7E9Dki.png?imageslim" alt="mark"><br>以下是8253模式控制寄存器<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/7I9a6el9KE.png?imageslim" alt="mark"><br>也就是端口43h写入寄存器的格式。下面是计数器模式位：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/k1EG6k1AfE.png?imageslim" alt="mark"><br>下面是读/写/锁位:<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/4l3l5Jl7kk.png?imageslim" alt="mark"><br>下面是计数器选择位：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/1IBI0KlEgI.png?imageslim" alt="mark"><br>make一下，运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/66klAkE9cA.png?imageslim" alt="mark"></p>
<h1 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h1><h2 id="避免对称–进程的节奏感"><a href="#避免对称–进程的节奏感" class="headerlink" title="避免对称–进程的节奏感"></a>避免对称–进程的节奏感</h2><p>前面的进程延迟相同，现在将其改变下A、B、C三个的延迟分别为300、900、1500ms，运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/6L3b4dhc45.png?imageslim" alt="mark"><br>从这个我们可以想到，通过延迟的不同设置不同的优先级。<br>通过“轻重缓急”反应在时间上，来表达优先级调度，最重要的事情应该被赋予更高的优先级，应该给予更多的时间。<br>我们给每一个进程都添加一个变量，在一段时间 的开头，这个变量的值又大又下，进程获得一个运行周期，这个变量就减1，当减到0，此进程就不再获得执行的机会，指导所有进程都为0。<br>由于每一次进程调度的时候只有某一个进程的ticks会减少1，所以总共调度的次数应该是3个进程的ticks之和（150+50+30）=230。所以:</p>
<ul>
<li>进程A执行循环的次数为：（100+20x2+30x3）/20=230/20=11.5次</li>
<li>进程B执行循环的次数为：（0+20x2+30x3）/20=230/20=6.5次</li>
<li>进程C执行循环的次数为：（0+0x2+30x3）/20=230/20=4.5次<br>将各个进程的延迟时间改为10m后，make一下，运行如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180305/GiBeb7Lcef.png?imageslim" alt="mark"></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/" itemprop="url">《ORANGE-s-一个操作系统实现》进程（4-1）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T11:44:38+08:00">
                2018-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/" class="cy_cmt_count" data-xid="2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/03/04/《ORANGE-s-一个操作系统实现》进程（4-1）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》进程（4-1）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="进程概述"><a href="#进程概述" class="headerlink" title="进程概述"></a>进程概述</h1><h2 id="进程介绍"><a href="#进程介绍" class="headerlink" title="进程介绍"></a>进程介绍</h2><p>系统中运行的若干进程可以类比成一个人在一天内要做的若干样工作：总体看来，每样工作相对独立，并可产生某种结果；从细节上看，每样工作都具有自己的办法、工具和需要的资源；从时间上看，每一个时刻只能有一项工作正在处理中，各项工作可以轮换来做，这对于最终结果没有影响。<br>进程类似，从宏观上看，它有自己的目标，或者说功能，同时又能受控于进程调度模块，从微观来看，她可以利用系统的资源，有自己的代码和数据，同时拥有自己的堆栈；进程需要被调度，就好比一个人轮换做不同的工作。示意图如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/bh7mml4L4m.png?imageslim" alt="mark"></p>
<h2 id="形成进程的必要考虑"><a href="#形成进程的必要考虑" class="headerlink" title="形成进程的必要考虑"></a>形成进程的必要考虑</h2><p>因为进程数是多余CPU数的，于是在同一时刻，总是有“正在运行的”和“正在休息的”进程。所以，对于“正在休息的”进程，我们需要让它在重新醒来的时候记住自己挂起之前的状态，以便让原来的任务继续执行下去。<br>所以，我们要一个数据结构记录一个进程的状态，在进程要被挂起的时候，进程信息就被写入这个数据结构，等到进程重新启动的时候，这个信息重新被读出来。如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/aID0CgLFCF.png?imageslim" alt="mark"></p>
<h2 id="最简单的进程"><a href="#最简单的进程" class="headerlink" title="最简单的进程"></a>最简单的进程</h2><p>我们设想，当一个进程运行的时候，突然发生了时钟中断，特权级从ring1跳到ring0，开始执行时钟中断处理程序，中断处理程序这时调用进程调度模块，指定下一个应该运行的程序，当中断处理程序结束时，下一个进程准备就绪并开始运行，特权级又从ring0跳回ring1。我们把这个过程按照时间顺序整理如下：</p>
<ol>
<li>进程A运行中</li>
<li>时钟中断发生，ring1-&gt;ring0，时钟中断处理程序启动。</li>
<li>进程调度，下一个应该运行的进程B被指定</li>
<li>进程B被恢复，ring0-&gt;ring1</li>
<li>进程B运行中。<br>而要想实现这些功能，我们必须完成的应该有以下几项：</li>
<li>时钟中断处理程序</li>
<li>进程调度模块</li>
<li>两个进程<br>进程切换图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/6eI6DB9GfB.png?imageslim" alt="mark"><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="进程控制块PCB（也叫做进程表）"><a href="#进程控制块PCB（也叫做进程表）" class="headerlink" title="进程控制块PCB（也叫做进程表）"></a>进程控制块PCB（也叫做进程表）</h3>它相当于进程的提纲，通过PCB我们可以很方便的进行进程管理。<br>因为我们会有跟多个PCB所以会形成如图所示的进程表：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/97im0kF4lK.png?imageslim" alt="mark"><h3 id="进程栈和内核栈"><a href="#进程栈和内核栈" class="headerlink" title="进程栈和内核栈"></a>进程栈和内核栈</h3>当寄存器的值已经被保存到进程表内，进程调度模块就开始执行了，寄存器被压到进程表之后，esp汁指向进程表某个位置的。为了避免错误的出现，一定要将esp指向专门的内核栈区域。这样在短短的进程切换过程中，esp的位置出现在3个不同的区域：</li>
</ol>
<ul>
<li>进程栈：进程运行时自身的堆栈</li>
<li>进程表：存储进程状态信息的数据结构</li>
<li>内核栈：进程调度模块运行时使用的堆栈<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/ibf2DLm9H4.png?imageslim" alt="mark"><h3 id="第一步-ring0-gt-ring1"><a href="#第一步-ring0-gt-ring1" class="headerlink" title="第一步:ring0-&gt;ring1"></a>第一步:ring0-&gt;ring1</h3></li>
</ul>
<p>在开始第一个进程时，我们用iretd来实现由ring0-&gt;ring1的转移，一旦转移成功，便可以认为已经在一个进程中运行了。如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">restart:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">esp</span>, [p_proc_ready]</span><br><span class="line">	<span class="keyword">lldt</span>	[<span class="built_in">esp</span> + P_LDT_SEL]</span><br><span class="line">	<span class="keyword">lea</span>	<span class="built_in">eax</span>, [<span class="built_in">esp</span> + P_STACKTOP]</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dword</span> [tss + TSS3_S_SP0], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">restart_reenter:</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">dword</span> [k_reenter]</span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">gs</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">fs</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">es</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">ds</span></span><br><span class="line">	<span class="keyword">popad</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">esp</span>, <span class="number">4</span></span><br><span class="line">	<span class="keyword">iretd</span></span><br></pre></td></tr></table></figure></p>
<p>其中，指针p_proc_ready是指向PCB的指针，PCB的信息被结构体s_proc存储。当要恢复一个进程时，便将esp指向这个结构体的开始处，然后运行一系列的pop命令，将寄存器值弹出。进程表的开始位置结构图如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/b8Lfe9ELli.png?imageslim" alt="mark"></p>
<h3 id="时钟中断处理程序"><a href="#时钟中断处理程序" class="headerlink" title="时钟中断处理程序"></a>时钟中断处理程序</h3><p>我们只完成最简单的ring0到ring1的转移，做到这一点用一个iretd指令就够了</p>
<h3 id="PCB、进程体、GDT、TSS"><a href="#PCB、进程体、GDT、TSS" class="headerlink" title="PCB、进程体、GDT、TSS"></a>PCB、进程体、GDT、TSS</h3><p>既然在进程开始之前要用到进程表中各项的值，我们应该先将这些值进行初始化，只要制定好各段寄存器、eip、esp以及eflags，它就可以正常运行，至于其他寄存器是用不到的，所以我们得出这样的必须初始化的寄存器列表：cs、ds、es、fs、gs、ss、esp、eip、eflags。<br>在Loader中，gs对应的描述符DPL为3，所以进程中的代码是有访问权限访问显存的；其他段寄存器对应的描述符基地址和段界限与先前的段寄存器对应的秒速恢复基地址金和段界限相同，只是改变它们的RPL和TI，以表示它们运行的特权级。<br>进程表和与之相关的TSS的对应关系如图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/GbKcmjGH0d.png?imageslim" alt="mark"><br>主要分为三个部分：</p>
<ol>
<li>进程表和GDT。进程表内的LDTSelector对应的GDT中的一个描述符，而这个描述符所指向的内存空间就存在进程表内。</li>
<li>进程表和进程。进程表就是进程的描述，进程运行过程中如果被中断，各个寄存器的值都会被保存进进程表中。但是，在我们的第一个进程开始之前，并不需要初始化太多内容，只需要知道进程的入口地址就足够了。</li>
<li>GDT和TSS。GDT中需要有一个描述符来对应TSS，需要事先初始化这个描述符。<br>接着开始具体初始化，<br>第一步，首先准备一个小的进程体：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestA</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		disp_str(<span class="string">"A"</span>);</span><br><span class="line">		disp_int(i++);</span><br><span class="line">		disp_str(<span class="string">"."</span>);</span><br><span class="line">		delay(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这个进程体（函数）的功能就是打印一个字符并显示数字，并稍微停顿。<br>接着我们要注视掉hlt，并让程序跳转到kernel_main()中。<br>delay()函数也就是一个循环嵌套。<br>第二步，初始化进程表。<br>首先收进程表的结构定义：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="class"><span class="keyword">struct</span> <span class="title">s_stackframe</span></span> &#123;</span><br><span class="line">	<span class="built_in">u32</span>	gs;		<span class="comment">/* \                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	fs;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	es;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	ds;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	edi;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	esi;		<span class="comment">/* | pushed by save()                   */</span></span><br><span class="line">	<span class="built_in">u32</span>	ebp;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	kernel_esp;	<span class="comment">/* &lt;- 'popad' will ignore it            */</span></span><br><span class="line">	<span class="built_in">u32</span>	ebx;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	edx;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	ecx;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	eax;		<span class="comment">/* /                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	retaddr;	<span class="comment">/* return addr for kernel.asm::save()   */</span></span><br><span class="line">	<span class="built_in">u32</span>	eip;		<span class="comment">/* \                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	cs;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	eflags;		<span class="comment">/* | pushed by CPU during interrupt     */</span></span><br><span class="line">	<span class="built_in">u32</span>	esp;		<span class="comment">/* |                                    */</span></span><br><span class="line">	<span class="built_in">u32</span>	ss;		<span class="comment">/* /                                    */</span></span><br><span class="line">&#125;STACK_FRAME;</span><br></pre></td></tr></table></figure></p>
<p>然后在global.c中声明一个进程表：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC PROCESS proc_table[NR_TASKS]<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>其中NR_TASKS定义了最大允许进程，我们将其设为1。为了以后扩展，我们将其还是声明成一个数组。<br>接着就初始化进程表：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PROCESS* p_proc	= proc_table;</span><br><span class="line"></span><br><span class="line">	p_proc-&gt;ldt_sel	= SELECTOR_LDT_FIRST;</span><br><span class="line">	memcpy(&amp;p_proc-&gt;ldts[<span class="number">0</span>], &amp;gdt[SELECTOR_KERNEL_CS&gt;&gt;<span class="number">3</span>], sizeof(DESCRIPTOR));</span><br><span class="line">	p_proc-&gt;ldts[<span class="number">0</span>].attr1 = DA_C | <span class="type">PRIVILEGE_TASK</span> &lt;&lt; <span class="number">5</span>;	// <span class="built_in">change</span> the DPL</span><br><span class="line">	memcpy(&amp;p_proc-&gt;ldts[<span class="number">1</span>], &amp;gdt[SELECTOR_KERNEL_DS&gt;&gt;<span class="number">3</span>], sizeof(DESCRIPTOR));</span><br><span class="line">	p_proc-&gt;ldts[<span class="number">1</span>].attr1 = DA_DRW | <span class="type">PRIVILEGE_TASK</span> &lt;&lt; <span class="number">5</span>;	// <span class="built_in">change</span> the DPL</span><br><span class="line"></span><br><span class="line">	p_proc-&gt;regs.cs	= (<span class="number">0</span> &amp; SA_RPL_MASK &amp; SA_TI_MASK) | <span class="type">SA_TIL</span> | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.ds	= (<span class="number">8</span> &amp; SA_RPL_MASK &amp; SA_TI_MASK) | <span class="type">SA_TIL</span> | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.es	= (<span class="number">8</span> &amp; SA_RPL_MASK &amp; SA_TI_MASK) | <span class="type">SA_TIL</span> | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.fs	= (<span class="number">8</span> &amp; SA_RPL_MASK &amp; SA_TI_MASK) | <span class="type">SA_TIL</span> | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.ss	= (<span class="number">8</span> &amp; SA_RPL_MASK &amp; SA_TI_MASK) | <span class="type">SA_TIL</span> | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.gs	= (SELECTOR_KERNEL_GS &amp; SA_RPL_MASK) | <span class="type">RPL_TASK</span>;</span><br><span class="line">	p_proc-&gt;regs.eip= (u32)TestA;</span><br><span class="line">	p_proc-&gt;regs.esp= (u32) task_stack + STACK_SIZE_TOTAL;</span><br><span class="line">	p_proc-&gt;regs.eflags = <span class="number">0x1202</span>;	// <span class="keyword">IF</span>=<span class="number">1</span>, IOPL=<span class="number">1</span>, bit <span class="number">2</span> is always <span class="number">1.</span></span><br></pre></td></tr></table></figure></p>
<p>进程表的初始化主要有寄存器、LDTSelector和LDT。<br>LDTSelector被赋值为SELECTOR_LDT_FIRST。LDT中共有两个描述符，分别被初始化成内核代码段和内核数据段，只是改变一下DPL以让其运行在低的特权级下。<br>要初始化的寄存器比较多，其中eip指向TestA，这表名进程将从TestA的入口开始运行。<br>另外，esp指向了单独的栈，栈的大小为STACK_SIZE_TOTAL。<br>最后一行是设置eflags,0x1202恰好设置了IF位，并把IOPL设为1.这样进程就可以使用I/O指令，并且中断会在iretd执行时被打开。<br>第三步，准备GDT和TSS。<br>到此，只有TSS和它对应的描述符没有初始化了。在init_prot（），填充TSS以及对应的描述符。</p>
<h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><p>make以后，就运行成功了：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/97fg5aCG34.png?imageslim" alt="mark"></p>
<h3 id="第一个进程回顾"><a href="#第一个进程回顾" class="headerlink" title="第一个进程回顾"></a>第一个进程回顾</h3><p><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180304/2gei9B2Gfa.png?imageslim" alt="mark"><br>从上面的进程启动的示意图可以看出，进程体TestA()在内核被LOADER放置到内存中之后就准备好了。</p>
<h2 id="第二步，丰富中断处理程序"><a href="#第二步，丰富中断处理程序" class="headerlink" title="第二步，丰富中断处理程序"></a>第二步，丰富中断处理程序</h2><h3 id="让时钟中断开始起作用"><a href="#让时钟中断开始起作用" class="headerlink" title="让时钟中断开始起作用"></a>让时钟中断开始起作用</h3><p>现在打开i8259.c的init_8259A(),同时设置EOI。为了让中断显示出来，我们将通过改变屏幕第0行、第0列字符的方式来说明中断例程正在运行。</p>
<h3 id="现场的保护和恢复"><a href="#现场的保护和恢复" class="headerlink" title="现场的保护和恢复"></a>现场的保护和恢复</h3><p>使用进程表是为了保存进程的状态，以便中断处理程序完成之后需要被恢复的进程能够被顺利地恢复。在进程表中，我们为每一个寄存器预留了位置，以便将其保存下来，这样就可以在进程调度模块中尽情的使用这些寄存器，而不必担心会对进程产生不良影响。</p>
<h3 id="赋值tss-esp0"><a href="#赋值tss-esp0" class="headerlink" title="赋值tss.esp0"></a>赋值tss.esp0</h3><p>中断的打开意味着ring0和ring1之间频繁的切换，两个层级之间的切换包含两方面，一是代码的跳转，还有一个不容忽视的地方，就是堆栈也在切换。TSS的用处知识保存ring0堆栈信息，而堆栈的信息就是ss和esp两个寄存器。由于要为先一次ring1-&gt;ring0做准备，所以用iretd返回之前要保证tss.esp0是正确的。<br>当进程被中断切换到内核态时，当前的各个寄存器应该被立即保存（压栈）。也就是tss.esp0应该是当前进程的进程表中保存寄存器值的地方，即struct s_proc中struct中s_stackframe的最高地址处。这样进程被挂起后才恰好保存寄存到正确的位置。<br>现在的中断程序变成了：在中断发生的开始，esp的值是刚刚从TSS里面取到的进程表A中regs的最高地址，然后各个寄存器值被压栈入进程表，最后esp指向regs的最低地址处，然后设置tss.esp0的值，准备下一次进程被中断时使用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/" itemprop="url">《ORANGE-s-一个操作系统实现》内核雏形（3-2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T18:04:31+08:00">
                2018-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/" class="cy_cmt_count" data-xid="2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-2）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》内核雏形（3-2）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="跳入保护模式"><a href="#跳入保护模式" class="headerlink" title="跳入保护模式"></a>跳入保护模式</h2><p>首先是GDT以及对应的选择子，我们只定义三个描述符，分别是0~4GB的可执行段、0~4GB可读写段和一个指向显存开始地址的段。<br>因为段地址已经被确定为BaseOfLoader,所以Loader中出现的标号的物理地址可以用下面的公式表示：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">物理地址 = <span class="keyword">BaseOfLoader </span>x <span class="number">10</span>h + 变量的偏移</span><br></pre></td></tr></table></figure></p>
<p>然后运行后，如果看到字母“p”则代表我们进入了保护模式，如图所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/D0HELa024G.png?imageslim" alt="mark"></p>
<h2 id="重新放置内核以及控制器的转让"><a href="#重新放置内核以及控制器的转让" class="headerlink" title="重新放置内核以及控制器的转让"></a>重新放置内核以及控制器的转让</h2><p>下图是一个内存的使用分布图。<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/a5liccl973.png?imageslim" alt="mark"><br>虽然引导扇区将剩余的内存空间分割成了两块，但实际上引导扇区在完成了它的使命之后就没有用了，可以视为空闲内存。<br>运行之后，可以看到K字母，即代表成功由内核在控制了。<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/i1HDh6BLje.png?imageslim" alt="mark"></p>
<h1 id="扩充内核"><a href="#扩充内核" class="headerlink" title="扩充内核"></a>扩充内核</h1><h2 id="切换堆栈和GDT"><a href="#切换堆栈和GDT" class="headerlink" title="切换堆栈和GDT"></a>切换堆栈和GDT</h2><p>代码如下：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SELECTOR_KERNEL_CS	equ	<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 导入函数</span></span><br><span class="line"><span class="keyword">extern	</span>cstart</span><br><span class="line"></span><br><span class="line"><span class="comment">; 导入全局变量</span></span><br><span class="line"><span class="keyword">extern	</span>gdt_ptr</span><br><span class="line"></span><br><span class="line">[SECTION .<span class="keyword">bss]</span></span><br><span class="line"><span class="keyword">StackSpace	</span>	resb	<span class="number">2</span> * <span class="number">1024</span></span><br><span class="line"><span class="symbol">StackTop:</span>		<span class="comment">; 栈顶</span></span><br><span class="line"></span><br><span class="line">[section <span class="meta">.text</span>]	<span class="comment">; 代码在此</span></span><br><span class="line"></span><br><span class="line">global _start	<span class="comment">; 导出 _start</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">mov	esp, StackTop	<span class="comment">; 堆栈在 bss 段中</span></span><br><span class="line"></span><br><span class="line">	sgdt	[gdt_ptr]	<span class="comment">; cstart() 中将会用到 gdt_ptr</span></span><br><span class="line">	call	cstart		<span class="comment">; 在此函数中改变了gdt_ptr，让它指向新的GDT</span></span><br><span class="line">	lgdt	[gdt_ptr]	<span class="comment">; 使用新的GDT</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;lidt	[idt_ptr]</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">jmp	</span>SELECTOR_KERNEL_CS:csinit</span><br><span class="line"><span class="symbol">csinit:</span>		<span class="comment">; “这个跳转指令强制使用刚刚初始化的结构”——&lt;&lt;OS:D&amp;I 2nd&gt;&gt; P90.</span></span><br><span class="line"></span><br><span class="line">	push	<span class="number">0</span></span><br><span class="line">	popfd	<span class="comment">; Pop top of stack into EFLAGS</span></span><br><span class="line"></span><br><span class="line">	hlt</span><br></pre></td></tr></table></figure></p>
<p>从上可知，用简单的4个语句就完成了切换堆栈和更换GDT的任务。其中，StackTop定义在.bass段中，堆栈大小为2KB。操做GDT时用到的gdt_ptr和cstart分别是一个全局变量和全局函数，他们定义在start.c中，如下：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"type.h"</span></span><br><span class="line">#include <span class="string">"const.h"</span></span><br><span class="line">#include <span class="string">"protect.h"</span></span><br><span class="line"></span><br><span class="line">PUBLIC	void*	memcpy(void* pDst, void* pSrc, int iSize);</span><br><span class="line"></span><br><span class="line">PUBLIC	void	disp_str(char * pszInfo);</span><br><span class="line"></span><br><span class="line">PUBLIC	u8		gdt_ptr[<span class="number">6</span>];	<span class="comment">/* 0~15:Limit  16~47:Base */</span></span><br><span class="line">PUBLIC	DESCRIPTOR	gdt[GDT_SIZE];</span><br><span class="line"></span><br><span class="line">PUBLIC void cstart()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	disp_str(<span class="string">"<span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span><span class="subst">\n</span>"</span></span><br><span class="line">		 <span class="string">"-----<span class="subst">\"</span>cstart<span class="subst">\"</span> begins-----<span class="subst">\n</span>"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 将 LOADER 中的 GDT 复制到新的 GDT 中 */</span></span><br><span class="line">	memcpy(&amp;gdt,				   <span class="comment">/* New GDT */</span></span><br><span class="line">	       (void*)(*((u32*)(&amp;gdt_ptr[<span class="number">2</span>]))),    <span class="comment">/* Base  of Old GDT */</span></span><br><span class="line">	       *((u16*)(&amp;gdt_ptr[<span class="number">0</span>])) + <span class="number">1</span>	   <span class="comment">/* Limit of Old GDT */</span></span><br><span class="line">		);</span><br><span class="line">	<span class="comment">/* gdt_ptr[6] 共 6 个字节：0~15:Limit  16~47:Base。用作 sgdt/lgdt 的参数。*/</span></span><br><span class="line">	u16* p_gdt_limit = (u16*)(&amp;gdt_ptr[<span class="number">0</span>]);</span><br><span class="line">	u32* p_gdt_base  = (u32*)(&amp;gdt_ptr[<span class="number">2</span>]);</span><br><span class="line">	*p_gdt_limit = GDT_SIZE * sizeof(DESCRIPTOR) - <span class="number">1</span>;</span><br><span class="line">	*p_gdt_base  = (u32)&amp;gdt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>cstart()首先把位于Loader中的原GDT全部复制给心得GDT，然后把gdt_ptr中的内容换成新的GDT的基地址和界限。复制GDT使用的是函数memcpy。<br>运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/4cCmIF11FC.png?imageslim" alt="mark"></p>
<h2 id="整理文件"><a href="#整理文件" class="headerlink" title="整理文件"></a>整理文件</h2><ul>
<li>boot.asm和loader.asm放在单独的目录/boot中，相应的头文件也放在里面；</li>
<li>klib.asm和string.asm放在/lib中，作为库；</li>
<li>kernel.asm和start.c放在/kernel里面<br>目录树如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/4l4k0mll3K.png?imageslim" alt="mark"><h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2>当我们把文件放在不同的文件夹了以后，编译的命令会更加的复杂，所以，我们将使用Makefile，从而输入一行命令就可以完成整个编译过程，相关的文件放在/boot中，具体代码如下：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile for boot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Programs, flags, etc.</span></span><br><span class="line">ASM		= nasm</span><br><span class="line">ASMFLAGS	= -I <span class="keyword">include</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># This Program</span></span><br><span class="line">TARGET		= boot.bin loader.bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># All Phony Targets</span></span><br><span class="line">.PHONY : everything clean all</span><br><span class="line"></span><br><span class="line"><span class="comment"># Default starting position</span></span><br><span class="line">everything : <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">	rm -f <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line">all : clean everything</span><br><span class="line"></span><br><span class="line">boot.bin : boot.asm <span class="keyword">include</span>/load.inc <span class="keyword">include</span>/fat12hdr.inc</span><br><span class="line">	<span class="variable">$(ASM)</span> <span class="variable">$(ASMFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line">loader.bin : loader.asm <span class="keyword">include</span>/load.inc <span class="keyword">include</span>/fat12hdr.inc <span class="keyword">include</span>/pm.inc</span><br><span class="line">	<span class="variable">$(ASM)</span> <span class="variable">$(ASMFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>以字符#开头的行是注释、=用来定义变量，ASM和ASMFLAGS就是两个变量，使用他们的时候要用$(ASM)和$(ASMFLAGS)。Makefile的最重要的语法如下：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">target: prerequisites</span><br><span class="line">        <span class="keyword">command</span></span><br></pre></td></tr></table></figure></p>
<p>上面这样的形式表示：</p>
<ol>
<li>要想得到target，需要执行命令command.</li>
<li>target依赖prerequisites，当prerequisites中至少有一个文件比target文件新时，command才被执行。<br>比如这个Makefile的最后两行，翻译出来就是：</li>
<li>要想得到loader.bin，需要执行“$(ASM) $(ASMFLAGS) -o $@ $&lt;”。</li>
<li>loader.bin依赖一下文件：</li>
</ol>
<ul>
<li>loader.asm</li>
<li>include/load.inc</li>
<li>include/pm.inc</li>
<li>include/fat12hdr.inc<br>当他们中至少有一个比loader.bin新的时候，command被执行。<br>其中 $@代表target $&lt;代表prerequisites的第一个名字。<br>所以执行“make clean”，将会执行“rm -f $(TARGET)”也就是“rm -f boot.bin loader.bin”<br>以下是执行make all和make的结果图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/EC2GK4cgcm.png?imageslim" alt="mark"><br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/h782J4BeGK.png?imageslim" alt="mark"><br>接着对makefile扩展之后，我们可以通过make building 和make image很方便的把引导扇区、load.bin和kernel。bin写入虚拟软盘。如下所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/8FDma1Bam7.png?imageslim" alt="mark"><br>然后再启动bochs，同时在start.c加上显示cstart end，来表示我们的make正常的进行了编译连接了，结果如图所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/Ga4ccAcHb8.png?imageslim" alt="mark"><h2 id="添加中断处理"><a href="#添加中断处理" class="headerlink" title="添加中断处理"></a>添加中断处理</h2>中断要做的工作为：设置8259A和建立IDT。先写函数设置8259A:<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC void i<span class="symbol">nit_8259</span>A<span class="comment">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Master 8259, ICW1. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_M_CTL,	0x11)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slave  8259, ICW1. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_S_CTL,	0x11)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Master 8259, ICW2. 设置 '主8259' 的中断入口地址为 0x20. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_M_CTLMASK,	INT_VECTOR_IRQ0)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slave  8259, ICW2. 设置 '从8259' 的中断入口地址为 0x28 */</span></span><br><span class="line">	out_byte<span class="comment">(INT_S_CTLMASK,	INT_VECTOR_IRQ8)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Master 8259, ICW3. IR2 对应 '从8259'. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_M_CTLMASK,	0x4)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slave  8259, ICW3. 对应 '主8259' 的 IR2. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_S_CTLMASK,	0x2)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Master 8259, ICW4. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_M_CTLMASK,	0x1)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slave  8259, ICW4. */</span></span><br><span class="line">	out_byte<span class="comment">(INT_S_CTLMASK,	0x1)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Master 8259, OCW1.  */</span></span><br><span class="line">	out_byte<span class="comment">(INT_M_CTLMASK,	0xFF)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slave  8259, OCW1.  */</span></span><br><span class="line">	out_byte<span class="comment">(INT_S_CTLMASK,	0xFF)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>相应端口的宏如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 8259A interrupt controller ports. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INT_M_CTL     0x20 <span class="comment">/* I/O port for interrupt controller       &lt;Master&gt; */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INT_M_CTLMASK 0x21 <span class="comment">/* setting bits in this port disables ints &lt;Master&gt; */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INT_S_CTL     0xA0 <span class="comment">/* I/O port for second interrupt controller&lt;Slave&gt;  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INT_S_CTLMASK 0xA1 <span class="comment">/* setting bits in this port disables ints &lt;Slave&gt;  */</span></span></span><br><span class="line">......</span><br><span class="line"><span class="comment">/* 中断向量 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	INT_VECTOR_IRQ0			0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	INT_VECTOR_IRQ8			0x28</span></span><br></pre></td></tr></table></figure></p>
<p>这个函数只用到了一个函数，就是用来写端口的out_byte，该函数体位于kliba.asm。其中不仅有out_byte对端口进行写操作还有in_byte对端口进行读操作，由于端口操作可能需要时间，所以两个函数中加了点空操作表，以便有微笑的延迟。代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ========================================================================</span></span><br><span class="line"><span class="comment">;                  void out_byte(u16 port, u8 value);</span></span><br><span class="line"><span class="comment">; ========================================================================</span></span><br><span class="line"><span class="symbol">out_byte:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">edx</span>, [<span class="built_in">esp</span> + <span class="number">4</span>]		<span class="comment">; port</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, [<span class="built_in">esp</span> + <span class="number">4</span> + <span class="number">4</span>]	<span class="comment">; value</span></span><br><span class="line">	<span class="keyword">out</span>	<span class="built_in">dx</span>, <span class="built_in">al</span></span><br><span class="line">	<span class="keyword">nop</span>	<span class="comment">; 一点延迟</span></span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; ========================================================================</span></span><br><span class="line"><span class="comment">;                  u8 in_byte(u16 port);</span></span><br><span class="line"><span class="comment">; ========================================================================</span></span><br><span class="line"><span class="symbol">in_byte:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">edx</span>, [<span class="built_in">esp</span> + <span class="number">4</span>]		<span class="comment">; port</span></span><br><span class="line">	<span class="keyword">xor</span>	<span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">	<span class="keyword">in</span>	<span class="built_in">al</span>, <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">nop</span>	<span class="comment">; 一点延迟</span></span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line">	<span class="keyword">ret</span></span><br></pre></td></tr></table></figure></p>
<p>这两个函数放在include/proto.h中，这是一个新建立的头文件，用来存放函数声明。<br>然后，还要修改Makefile，不但要添加新的目标kernel/i8259.o，而且由于头文件的变化，kernel/start.o的依赖关系也稍微有变化：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OBJS		= kernel/kernel<span class="selector-class">.o</span> kernel/start<span class="selector-class">.o</span> kernel/i8259<span class="selector-class">.o</span> kernel/global<span class="selector-class">.o</span> kernel/protect<span class="selector-class">.o</span> lib/klib<span class="selector-class">.o</span> lib/kliba<span class="selector-class">.o</span> lib/string.o</span><br><span class="line">DASMOUTPUT	= kernel<span class="selector-class">.bin</span><span class="selector-class">.asm</span></span><br><span class="line">......</span><br><span class="line">kernel/start<span class="selector-class">.o</span>: kernel/start<span class="selector-class">.c</span> include/type<span class="selector-class">.h</span> include/const<span class="selector-class">.h</span> include/protect<span class="selector-class">.h</span> \</span><br><span class="line">		include/proto<span class="selector-class">.h</span> include/string.h</span><br><span class="line">	$(CC) $(CFLAGS) -o $@ $&lt;</span><br><span class="line"></span><br><span class="line">kernel/i8259<span class="selector-class">.o</span> : kernel/i8259<span class="selector-class">.c</span> include/type<span class="selector-class">.h</span> include/const<span class="selector-class">.h</span> include/protect<span class="selector-class">.h</span> \</span><br><span class="line">			include/proto.h</span><br><span class="line">	$(CC) $(CFLAGS) -o $@ $&lt;</span><br></pre></td></tr></table></figure></p>
<p>我们使用gcc -M自动生成依赖关系如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/g0h8FDbgFJ.png?imageslim" alt="mark">。<br>下面初始化IDT，它和初始化GDT类似，所以初始化GDT的方法可以拿着用，先前的gdt[]等变量都在头文件global.h中了，这样增加了代码的美感和可读性。<br>GATE定义在protect.h中，如下：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 门描述符 */</span></span><br><span class="line">typedef <span class="class"><span class="keyword">struct</span> <span class="title">s_gate</span></span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">u16</span>	offset_low;	<span class="comment">/* Offset Low */</span></span><br><span class="line">	<span class="built_in">u16</span>	selector;	<span class="comment">/* Selector */</span></span><br><span class="line">	<span class="built_in">u8</span>	dcount;		<span class="comment">/* 该字段只在调用门描述符中有效。如果在利用</span></span><br><span class="line"><span class="comment">				   调用门调用子程序时引起特权级的转换和堆栈</span></span><br><span class="line"><span class="comment">				   的改变，需要将外层堆栈中的参数复制到内层</span></span><br><span class="line"><span class="comment">				   堆栈。该双字计数字段就是用于说明这种情况</span></span><br><span class="line"><span class="comment">				   发生时，要复制的双字参数的数量。*/</span></span><br><span class="line">	<span class="built_in">u8</span>	attr;		<span class="comment">/* P(1) DPL(2) DT(1) TYPE(4) */</span></span><br><span class="line">	<span class="built_in">u16</span>	offset_high;	<span class="comment">/* Offset High */</span></span><br><span class="line">&#125;GATE;</span><br></pre></td></tr></table></figure></p>
<p>接着，在kernel.asm中添加两句，导入idt_ptr这个符号，并加载IDT。<br>我们对异常的处理总体是，如果有错误码，则直接把向量号压栈，然后执行一个函数exception_handler；如果没有错误码，则现在栈中压入一个0xfffffff,再把向量号压栈并随后执行exception_handler。<br>下面是该函数：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC <span class="literal">void</span> exception_handler(int vec_no,int err_code,int eip,int cs,int eflags)</span><br><span class="line">&#123;</span><br><span class="line">	int i;</span><br><span class="line">	int text_color = <span class="number">0x74</span>; <span class="comment">/* 灰底红字 */</span></span><br><span class="line"></span><br><span class="line">	char * err_msg[] = &#123;<span class="string">"<span class="subst">#DE</span> Divide Error"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#DB</span> RESERVED"</span>,</span><br><span class="line">			    <span class="string">"--  NMI Interrupt"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#BP</span> Breakpoint"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#OF</span> Overflow"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#BR</span> BOUND Range Exceeded"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#UD</span> Invalid Opcode (Undefined Opcode)"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#NM</span> Device Not Available (No Math Coprocessor)"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#DF</span> Double Fault"</span>,</span><br><span class="line">			    <span class="string">"    Coprocessor Segment Overrun (reserved)"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#TS</span> Invalid TSS"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#NP</span> Segment Not Present"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#SS</span> Stack-Segment Fault"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#GP</span> General Protection"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#PF</span> Page Fault"</span>,</span><br><span class="line">			    <span class="string">"--  (Intel reserved. Do not use.)"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#MF</span> x87 FPU Floating-Point Error (Math Fault)"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#AC</span> Alignment Check"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#MC</span> Machine Check"</span>,</span><br><span class="line">			    <span class="string">"<span class="subst">#XF</span> SIMD Floating-Point Exception"</span></span><br><span class="line">	&#125;;</span><br><span class="line">		<span class="comment">/* 通过打印空格的方式清空屏幕的前五行，并把 disp_pos 清零 */</span></span><br><span class="line">	disp_pos = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">80</span>*<span class="number">5</span>;i++)&#123;</span><br><span class="line">		disp_str(<span class="string">" "</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	disp_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	disp_color_str(<span class="string">"Exception! --&gt; "</span>, text_color);</span><br><span class="line">	disp_color_str(err_msg[vec_no], text_color);</span><br><span class="line">	disp_color_str(<span class="string">"\n\n"</span>, text_color);</span><br><span class="line">	disp_color_str(<span class="string">"EFLAGS:"</span>, text_color);</span><br><span class="line">	disp_int(eflags);</span><br><span class="line">	disp_color_str(<span class="string">"CS:"</span>, text_color);</span><br><span class="line">	disp_int(cs);</span><br><span class="line">	disp_color_str(<span class="string">"EIP:"</span>, text_color);</span><br><span class="line">	disp_int(eip);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(err_code != <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">		disp_color_str(<span class="string">"Error code:"</span>, text_color);</span><br><span class="line">		disp_int(err_code);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以下就是中断异常的情况：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/64jFAiG2JH.png?imageslim" alt="mark"><br>所有的中断都会触发一个函数spurious_irq()，这个仅仅是把IRQ号打印出来。<br>接着，我们向主8259A相应端口写入了0xFD，由于0XFD对应的二进制是11111101，于是键盘中断被打开，而其他中断任然处于屏蔽状态，最后在kernel.asm中添加sti指令设置IF位，然后make后，当我们敲击键盘任意键就如出现如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180301/GE94l7gm3I.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/" itemprop="url">《ORANGE-s-一个操作系统实现》内核雏形（3-1）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T10:42:13+08:00">
                2018-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/" class="cy_cmt_count" data-xid="2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/02/28/《ORANGE-s-一个操作系统实现》内核雏形（3-1）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》内核雏形（3-1）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="在Linux下红汇编写Hello-World"><a href="#在Linux下红汇编写Hello-World" class="headerlink" title="在Linux下红汇编写Hello World"></a>在Linux下红汇编写Hello World</h1><p>因为在后面的很多工作中，都要用到汇编编程，所以我们先试试用汇编在Linux下编写Hello World，具体代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 编译链接方法</span></span><br><span class="line"><span class="comment">; (ld 的‘-s’选项意为“strip all”)</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; $ nasm -f elf hello.asm -o hello.o</span></span><br><span class="line"><span class="comment">; $ ld -s hello.o -o hello</span></span><br><span class="line"><span class="comment">; $ ./hello</span></span><br><span class="line"><span class="comment">; Hello, world!</span></span><br><span class="line"><span class="comment">; $</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">section</span> .data]	<span class="comment">; 数据在此</span></span><br><span class="line"></span><br><span class="line">strHello	<span class="built_in">db</span>	<span class="string">"Hello, world!"</span>, <span class="number">0Ah</span></span><br><span class="line">STRLEN		<span class="built_in">equ</span>	$ - strHello</span><br><span class="line"></span><br><span class="line">[<span class="meta">section</span> .text]	<span class="comment">; 代码在此</span></span><br><span class="line"></span><br><span class="line"><span class="meta">global</span> _start	<span class="comment">; 我们必须导出 _start 这个入口，以便让链接器识别</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">edx</span>, STRLEN</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ecx</span>, strHello</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ebx</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, <span class="number">4</span>		<span class="comment">; sys_write</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">0x80</span>		<span class="comment">; 系统调用</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ebx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, <span class="number">1</span>		<span class="comment">; sys_exit</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">0x80</span>		<span class="comment">; 系统调用</span></span><br></pre></td></tr></table></figure></p>
<p>运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/7EDm7lcAK7.png?imageslim" alt="mark"><br>以上代码我们只要明白一点，链接程序只能通过global关键字将默认入口点“_start”导出即可。</p>
<h1 id="汇编和C同步使用"><a href="#汇编和C同步使用" class="headerlink" title="汇编和C同步使用"></a>汇编和C同步使用</h1><p>这部分是今后会经常用到的，两者的调用方法如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/d6mE64AkAK.png?imageslim" alt="mark"><br>foo.asm的具体代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 编译链接方法</span></span><br><span class="line"><span class="comment">; (ld 的‘-s’选项意为“strip all”)</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; $ nasm -f elf foo.asm -o foo.o</span></span><br><span class="line"><span class="comment">; $ gcc -c bar.c -o bar.o</span></span><br><span class="line"><span class="comment">; $ ld -s hello.o bar.o -o foobar</span></span><br><span class="line"><span class="comment">; $ ./foobar</span></span><br><span class="line"><span class="comment">; the 2nd one</span></span><br><span class="line"><span class="comment">; $</span></span><br><span class="line"></span><br><span class="line"><span class="meta">extern</span> choose	<span class="comment">; int choose(int a, int b);</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">section</span> .data]	<span class="comment">; 数据在此</span></span><br><span class="line"></span><br><span class="line">num1st		<span class="built_in">dd</span>	<span class="number">3</span></span><br><span class="line">num2nd		<span class="built_in">dd</span>	<span class="number">4</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">section</span> .text]	<span class="comment">; 代码在此</span></span><br><span class="line"></span><br><span class="line"><span class="meta">global</span> _start	<span class="comment">; 我们必须导出 _start 这个入口，以便让链接器识别。</span></span><br><span class="line"><span class="meta">global</span> myprint	<span class="comment">; 导出这个函数为了让 bar.c 使用</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">dword</span> [num2nd]	<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">dword</span> [num1st]	<span class="comment">;  |</span></span><br><span class="line">	<span class="keyword">call</span>	choose		<span class="comment">;  | choose(num1st, num2nd);</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">esp</span>, <span class="number">8</span>		<span class="comment">; /</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ebx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, <span class="number">1</span>		<span class="comment">; sys_exit</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">0x80</span>		<span class="comment">; 系统调用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; void myprint(char* msg, int len)</span></span><br><span class="line"><span class="symbol">myprint:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">edx</span>, [<span class="built_in">esp</span> + <span class="number">8</span>]	<span class="comment">; len</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ecx</span>, [<span class="built_in">esp</span> + <span class="number">4</span>]	<span class="comment">; msg</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ebx</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, <span class="number">4</span>		<span class="comment">; sys_write</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">0x80</span>		<span class="comment">; 系统调用</span></span><br><span class="line">	<span class="keyword">ret</span></span><br></pre></td></tr></table></figure></p>
<p>bar.c的具体代码如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprint</span><span class="params">(<span class="keyword">char</span>* msg, <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">choose</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(a &gt;= b)&#123;</span><br><span class="line">		myprint(<span class="string">"the 1st one\n"</span>, <span class="number">13</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		myprint(<span class="string">"the 2nd one\n"</span>, <span class="number">13</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果如图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/D6jI3Edeam.png?imageslim" alt="mark"><br>从代码中可以看出，其实global和extern两个关键字才是最关键的，可以方便地在汇编和C之间自由变换。</p>
<h1 id="ELF（Executable-and-Linkable-format）"><a href="#ELF（Executable-and-Linkable-format）" class="headerlink" title="ELF（Executable and Linkable format）"></a>ELF（Executable and Linkable format）</h1><p>下图为ELF文件的结构由ELF头、程序头表、节和节头表（实际上一个文件不一定包含全部这些内容，而且它们的位置也不一定如下，只有ELF头的位置是固定的，其余部分都是由ELF头中的各项值来决定的）<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/jdkd8E23Ee.png?imageslim" alt="mark"><br>下面是ELFheader的数据类型：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/b939LHC44G.png?imageslim" alt="mark"><br>在终端输入<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="keyword">include</span>/elf.<span class="built_in">h</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/AFfgKAFkBD.png?imageslim" alt="ELF header的格式"><br>其中各项额意义为：</p>
<ul>
<li>e_ident：其中包含用来表示ELF文件的字符，以及其他一些与机器无关的信息。<br>从下图可以很清楚的看出foobar文件的该信息：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/47Jk6EBK1f.png?imageslim" alt="mark"></li>
<li>e_type:标识文件的类型，其中2代表可执行文件</li>
<li>e_machine:表示改程序需要的体系结构，3为Intel80386</li>
<li>e_version:文件版本</li>
<li>e_entry:程序的入口，这里为0x80480A0</li>
<li>e_phoff:文件中的偏移量这里为0x34</li>
<li>e_ehsize:大小</li>
<li>e_phentsize:每一个条目的大小</li>
<li>e_phnum:条目数</li>
<li>e_shstrndx:包含节名称的字符串是第几个节。<br>从上面的Program header可以看出，foobar在内存中的加载为如下图所示：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/ELfBmA1k27.png?imageslim" alt="mark"><h1 id="从Loader到内核"><a href="#从Loader到内核" class="headerlink" title="从Loader到内核"></a>从Loader到内核</h1>研究完了ELF之后，我们接着就该完成Loader要做的两件事了</li>
<li>加载内存到内核</li>
<li>跳入保护模式<h2 id="用Loader加载ELF"><a href="#用Loader加载ELF" class="headerlink" title="用Loader加载ELF"></a>用Loader加载ELF</h2>首先，我们把FAT12文件有关的东西放进fat12hdr.inc中，供boot.asm和loader.asm共享，所以boot.asm开头部分的代码就如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/Jbjdd53016.png?imageslim" alt="mark"><br>下面我们修改loader.asm，让它把内核放进内存，其代码如下：<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line">org  <span class="number">0100h</span></span><br><span class="line"></span><br><span class="line">BaseOfStack		<span class="built_in">equ</span>	<span class="number">0100h</span></span><br><span class="line"></span><br><span class="line">BaseOfKernelFile	<span class="built_in">equ</span>	 <span class="number">08000h</span>	<span class="comment">; KERNEL.BIN 被加载到的位置 ----  段地址</span></span><br><span class="line">OffsetOfKernelFile	<span class="built_in">equ</span>	     <span class="number">0h</span>	<span class="comment">; KERNEL.BIN 被加载到的位置 ---- 偏移地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_START		<span class="comment">; Start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 下面是 FAT12 磁盘的头, 之所以包含它是因为下面用到了磁盘的一些信息</span></span><br><span class="line"><span class="meta">%include</span>	<span class="string">"fat12hdr.inc"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_START:</span>			<span class="comment">; &lt;--- 从这里开始 *************</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">sp</span>, BaseOfStack</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="number">0</span>			<span class="comment">; "Loading  "</span></span><br><span class="line">	<span class="keyword">call</span>	DispStr			<span class="comment">; 显示字符串</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">; 下面在 A 盘的根目录寻找 KERNEL.BIN</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">word</span> [wSectorNo], SectorNoOfRootDirectory	</span><br><span class="line">	<span class="keyword">xor</span>	<span class="number">ah</span>, <span class="number">ah</span>	<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">xor</span>	<span class="built_in">dl</span>, <span class="built_in">dl</span>	<span class="comment">;  | 软驱复位</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">13h</span>	<span class="comment">; /</span></span><br><span class="line"><span class="symbol">LABEL_SEARCH_IN_ROOT_DIR_BEGIN:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">word</span> [wRootDirSizeForLoop], <span class="number">0</span>	<span class="comment">; `.</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_NO_KERNELBIN		<span class="comment">;  | 判断根目录区是不是已经读完,</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">word</span> [wRootDirSizeForLoop]	<span class="comment">; /  读完表示没有找到 KERNEL.BIN</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, BaseOfKernelFile</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span>			<span class="comment">; es &lt;- BaseOfKernelFile</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, OffsetOfKernelFile	<span class="comment">; bx &lt;- OffsetOfKernelFile</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, [wSectorNo]		<span class="comment">; ax &lt;- Root Directory 中的某 Sector 号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">call</span>	ReadSector</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">si</span>, KernelFileName	<span class="comment">; ds:si -&gt; "KERNEL  BIN"</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">di</span>, OffsetOfKernelFile</span><br><span class="line">	<span class="keyword">cld</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dx</span>, <span class="number">10h</span></span><br><span class="line"><span class="symbol">LABEL_SEARCH_FOR_KERNELBIN:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">dx</span>, <span class="number">0</span>				  <span class="comment">; `.</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_GOTO_NEXT_SECTOR_IN_ROOT_DIR<span class="comment">;  | 循环次数控制, 如果已经读完</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">dx</span>				  <span class="comment">; /  了一个 Sector, 就跳到下一个</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cx</span>, <span class="number">11</span></span><br><span class="line"><span class="symbol">LABEL_CMP_FILENAME:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">cx</span>, <span class="number">0</span>			<span class="comment">; `.</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_FILENAME_FOUND	<span class="comment">;  | 循环次数控制, 如果比较了 11 个字符都</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">cx</span>			<span class="comment">; /  相等, 表示找到</span></span><br><span class="line">	<span class="keyword">lodsb</span>				<span class="comment">; ds:si -&gt; al</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">al</span>, <span class="built_in">byte</span> [<span class="built_in">es</span>:<span class="built_in">di</span>]	<span class="comment">; if al == es:di</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_GO_ON</span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_DIFFERENT</span><br><span class="line"><span class="symbol">LABEL_GO_ON:</span></span><br><span class="line">	<span class="keyword">inc</span>	<span class="built_in">di</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_CMP_FILENAME	<span class="comment">;	继续循环</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_DIFFERENT:</span></span><br><span class="line">	<span class="keyword">and</span>	<span class="built_in">di</span>, <span class="number">0FFE0h</span>		<span class="comment">; else`. 让 di 是 20h 的倍数</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">di</span>, <span class="number">20h</span>			<span class="comment">;      |</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">si</span>, KernelFileName	<span class="comment">;      | di += 20h  下一个目录条目</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_SEARCH_FOR_KERNELBIN<span class="comment">;   /</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_GOTO_NEXT_SECTOR_IN_ROOT_DIR:</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">word</span> [wSectorNo], <span class="number">1</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_SEARCH_IN_ROOT_DIR_BEGIN</span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_NO_KERNELBIN:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="number">2</span>			<span class="comment">; "No KERNEL."</span></span><br><span class="line">	<span class="keyword">call</span>	DispStr			<span class="comment">; 显示字符串</span></span><br><span class="line">%ifdef	_LOADER_DEBUG_</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="number">4c00h</span>		<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">21h</span>			<span class="comment">; / 没有找到 KERNEL.BIN, 回到 DOS</span></span><br><span class="line"><span class="meta">%else</span></span><br><span class="line">	<span class="keyword">jmp</span>	$			<span class="comment">; 没有找到 KERNEL.BIN, 死循环在这里</span></span><br><span class="line"><span class="meta">%endif</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_FILENAME_FOUND:</span>			<span class="comment">; 找到 KERNEL.BIN 后便来到这里继续</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, RootDirSectors</span><br><span class="line">	<span class="keyword">and</span>	<span class="built_in">di</span>, <span class="number">0FFF0h</span>		<span class="comment">; di -&gt; 当前条目的开始</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">eax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">eax</span>, [<span class="built_in">es</span> : <span class="built_in">di</span> + <span class="number">01Ch</span>]		<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dword</span> [dwKernelSize], <span class="built_in">eax</span>	<span class="comment">; / 保存 KERNEL.BIN 文件大小</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">eax</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">di</span>, <span class="number">01Ah</span>		<span class="comment">; di -&gt; 首 Sector</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cx</span>, <span class="built_in">word</span> [<span class="built_in">es</span>:<span class="built_in">di</span>]</span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">cx</span>			<span class="comment">; 保存此 Sector 在 FAT 中的序号</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">cx</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">cx</span>, DeltaSectorNo	<span class="comment">; cl &lt;- LOADER.BIN 的起始扇区号(0-based)</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, BaseOfKernelFile</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span>			<span class="comment">; es &lt;- BaseOfKernelFile</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, OffsetOfKernelFile	<span class="comment">; bx &lt;- OffsetOfKernelFile</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="built_in">cx</span>			<span class="comment">; ax &lt;- Sector 号</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_GOON_LOADING_FILE:</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">ax</span>			<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">bx</span>			<span class="comment">;  |</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ah</span>, <span class="number">0Eh</span>			<span class="comment">;  | 每读一个扇区就在 "Loading  " 后面</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="string">'.'</span>			<span class="comment">;  | 打一个点, 形成这样的效果:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bl</span>, <span class="number">0Fh</span>			<span class="comment">;  | Loading ......</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">10h</span>			<span class="comment">;  |</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bx</span>			<span class="comment">;  |</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">ax</span>			<span class="comment">; /</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">call</span>	ReadSector</span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">ax</span>			<span class="comment">; 取出此 Sector 在 FAT 中的序号</span></span><br><span class="line">	<span class="keyword">call</span>	GetFATEntry</span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">ax</span>, <span class="number">0FFFh</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_FILE_LOADED</span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">ax</span>			<span class="comment">; 保存 Sector 在 FAT 中的序号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dx</span>, RootDirSectors</span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">ax</span>, <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">ax</span>, DeltaSectorNo</span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">bx</span>, [BPB_BytsPerSec]</span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_GOON_LOADING_FILE</span><br><span class="line"><span class="symbol">LABEL_FILE_LOADED:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">call</span>	KillMotor		<span class="comment">; 关闭软驱马达</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="number">1</span>			<span class="comment">; "Ready."</span></span><br><span class="line">	<span class="keyword">call</span>	DispStr			<span class="comment">; 显示字符串</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">jmp</span>	$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;============================================================================</span></span><br><span class="line"><span class="comment">;变量</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line">wRootDirSizeForLoop	<span class="built_in">dw</span>	RootDirSectors	<span class="comment">; Root Directory 占用的扇区数</span></span><br><span class="line">wSectorNo		<span class="built_in">dw</span>	<span class="number">0</span>		<span class="comment">; 要读取的扇区号</span></span><br><span class="line">bOdd			<span class="built_in">db</span>	<span class="number">0</span>		<span class="comment">; 奇数还是偶数</span></span><br><span class="line">dwKernelSize		<span class="built_in">dd</span>	<span class="number">0</span>		<span class="comment">; KERNEL.BIN 文件大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;============================================================================</span></span><br><span class="line"><span class="comment">;字符串</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line">KernelFileName		<span class="built_in">db</span>	<span class="string">"KERNEL  BIN"</span>, <span class="number">0</span>	<span class="comment">; KERNEL.BIN 之文件名</span></span><br><span class="line"><span class="comment">; 为简化代码, 下面每个字符串的长度均为 MessageLength</span></span><br><span class="line">MessageLength		<span class="built_in">equ</span>	<span class="number">9</span></span><br><span class="line"><span class="symbol">LoadMessage:</span>		<span class="built_in">db</span>	<span class="string">"Loading  "</span></span><br><span class="line">Message1		<span class="built_in">db</span>	<span class="string">"Ready.   "</span></span><br><span class="line">Message2		<span class="built_in">db</span>	<span class="string">"No KERNEL"</span></span><br><span class="line"><span class="comment">;============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 函数名: DispStr</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 作用:</span></span><br><span class="line"><span class="comment">;	显示一个字符串, 函数开始时 dh 中应该是字符串序号(0-based)</span></span><br><span class="line"><span class="symbol">DispStr:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, MessageLength</span><br><span class="line">	<span class="keyword">mul</span>	<span class="number">dh</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">ax</span>, LoadMessage</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bp</span>, <span class="built_in">ax</span>			<span class="comment">; ┓</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="built_in">ds</span>			<span class="comment">; ┣ ES:BP = 串地址</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span>			<span class="comment">; ┛</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cx</span>, MessageLength	<span class="comment">; CX = 串长度</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="number">01301h</span>		<span class="comment">; AH = 13,  AL = 01h</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, <span class="number">0007h</span>		<span class="comment">; 页号为0(BH = 0) 黑底白字(BL = 07h)</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dl</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="number">dh</span>, <span class="number">3</span>			<span class="comment">; 从第 3 行往下显示</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">10h</span>			<span class="comment">; int 10h</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 函数名: ReadSector</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 作用:</span></span><br><span class="line"><span class="comment">;	从序号(Directory Entry 中的 Sector 号)为 ax 的的 Sector 开始, 将 cl 个 Sector 读入 es:bx 中</span></span><br><span class="line"><span class="symbol">ReadSector:</span></span><br><span class="line">	<span class="comment">; -----------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">; 怎样由扇区号求扇区在磁盘中的位置 (扇区号 -&gt; 柱面号, 起始扇区, 磁头号)</span></span><br><span class="line">	<span class="comment">; -----------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">; 设扇区号为 x</span></span><br><span class="line">	<span class="comment">;                           ┌ 柱面号 = y &gt;&gt; 1</span></span><br><span class="line">	<span class="comment">;       x           ┌ 商 y ┤</span></span><br><span class="line">	<span class="comment">; -------------- =&gt; ┤      └ 磁头号 = y &amp; 1</span></span><br><span class="line">	<span class="comment">;  每磁道扇区数     │</span></span><br><span class="line">	<span class="comment">;                   └ 余 z =&gt; 起始扇区号 = z + 1</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">bp</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bp</span>, <span class="built_in">sp</span></span><br><span class="line">	<span class="keyword">sub</span>	<span class="built_in">esp</span>, <span class="number">2</span>			<span class="comment">; 辟出两个字节的堆栈区域保存要读的扇区数: byte [bp-2]</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">byte</span> [<span class="built_in">bp</span>-<span class="number">2</span>], <span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">bx</span>			<span class="comment">; 保存 bx</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bl</span>, [BPB_SecPerTrk]	<span class="comment">; bl: 除数</span></span><br><span class="line">	<span class="keyword">div</span>	<span class="built_in">bl</span>			<span class="comment">; y 在 al 中, z 在 ah 中</span></span><br><span class="line">	<span class="keyword">inc</span>	<span class="number">ah</span>			<span class="comment">; z ++</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">ah</span>			<span class="comment">; cl &lt;- 起始扇区号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="built_in">al</span>			<span class="comment">; dh &lt;- y</span></span><br><span class="line">	<span class="keyword">shr</span>	<span class="built_in">al</span>, <span class="number">1</span>			<span class="comment">; y &gt;&gt; 1 (其实是 y/BPB_NumHeads, 这里BPB_NumHeads=2)</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ch</span>, <span class="built_in">al</span>			<span class="comment">; ch &lt;- 柱面号</span></span><br><span class="line">	<span class="keyword">and</span>	<span class="number">dh</span>, <span class="number">1</span>			<span class="comment">; dh &amp; 1 = 磁头号</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bx</span>			<span class="comment">; 恢复 bx</span></span><br><span class="line">	<span class="comment">; 至此, "柱面号, 起始扇区, 磁头号" 全部得到 ^^^^^^^^^^^^^^^^^^^^^^^^</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dl</span>, [BS_DrvNum]		<span class="comment">; 驱动器号 (0 表示 A 盘)</span></span><br><span class="line"><span class="symbol">.GoOnReading:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ah</span>, <span class="number">2</span>			<span class="comment">; 读</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="built_in">byte</span> [<span class="built_in">bp</span>-<span class="number">2</span>]		<span class="comment">; 读 al 个扇区</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">13h</span></span><br><span class="line">	<span class="keyword">jc</span>	.GoOnReading		<span class="comment">; 如果读取错误 CF 会被置为 1, 这时就不停地读, 直到正确为止</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">esp</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bp</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 函数名: GetFATEntry</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 作用:</span></span><br><span class="line"><span class="comment">;	找到序号为 ax 的 Sector 在 FAT 中的条目, 结果放在 ax 中</span></span><br><span class="line"><span class="comment">;	需要注意的是, 中间需要读 FAT 的扇区到 es:bx 处, 所以函数一开始保存了 es 和 bx</span></span><br><span class="line"><span class="symbol">GetFATEntry:</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">es</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, BaseOfKernelFile	<span class="comment">; ┓</span></span><br><span class="line">	<span class="keyword">sub</span>	<span class="built_in">ax</span>, <span class="number">0100h</span>		<span class="comment">; ┣ 在 BaseOfKernelFile 后面留出 4K 空间用于存放 FAT</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span>			<span class="comment">; ┛</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">byte</span> [bOdd], <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, <span class="number">3</span></span><br><span class="line">	<span class="keyword">mul</span>	<span class="built_in">bx</span>			<span class="comment">; dx:ax = ax * 3</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">div</span>	<span class="built_in">bx</span>			<span class="comment">; dx:ax / 2  ==&gt;  ax &lt;- 商, dx &lt;- 余数</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_EVEN</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">byte</span> [bOdd], <span class="number">1</span></span><br><span class="line"><span class="symbol">LABEL_EVEN:</span><span class="comment">;偶数</span></span><br><span class="line">	<span class="keyword">xor</span>	<span class="built_in">dx</span>, <span class="built_in">dx</span>			<span class="comment">; 现在 ax 中是 FATEntry 在 FAT 中的偏移量. 下面来计算 FATEntry 在哪个扇区中(FAT占用不止一个扇区)</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, [BPB_BytsPerSec]</span><br><span class="line">	<span class="keyword">div</span>	<span class="built_in">bx</span>			<span class="comment">; dx:ax / BPB_BytsPerSec  ==&gt;	ax &lt;- 商   (FATEntry 所在的扇区相对于 FAT 来说的扇区号)</span></span><br><span class="line">					<span class="comment">;				dx &lt;- 余数 (FATEntry 在扇区内的偏移)。</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, <span class="number">0</span>			<span class="comment">; bx &lt;- 0	于是, es:bx = (BaseOfKernelFile - 100):00 = (BaseOfKernelFile - 100) * 10h</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">ax</span>, SectorNoOfFAT1	<span class="comment">; 此句执行之后的 ax 就是 FATEntry 所在的扇区号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">call</span>	ReadSector		<span class="comment">; 读取 FATEntry 所在的扇区, 一次读两个, 避免在边界发生错误, 因为一个 FATEntry 可能跨越两个扇区</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">bx</span>, <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, [<span class="built_in">es</span>:<span class="built_in">bx</span>]</span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">byte</span> [bOdd], <span class="number">1</span></span><br><span class="line"><span class="symbol">	jnz	LABEL</span>_EVEN_2</span><br><span class="line">	<span class="keyword">shr</span>	<span class="built_in">ax</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">LABEL_EVEN_2:</span></span><br><span class="line">	<span class="keyword">and</span>	<span class="built_in">ax</span>, <span class="number">0FFFh</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_GET_FAT_ENRY_OK:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">es</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 函数名: KillMotor</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">; 作用:</span></span><br><span class="line"><span class="comment">;	关闭软驱马达</span></span><br><span class="line"><span class="symbol">KillMotor:</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dx</span>, <span class="number">03F2h</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">out</span>	<span class="built_in">dx</span>, <span class="built_in">al</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="comment">;----------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>下面接着就是写一个内核出来，文件名为kernel.asm<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 编译链接方法</span></span><br><span class="line"><span class="comment">; $ nasm -f elf kernel.asm -o kernel.o</span></span><br><span class="line"><span class="comment">; $ ld -s kernel.o -o kernel.bin    #‘-s’选项意为“strip all”</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">section</span> .text]	<span class="comment">; 代码在此</span></span><br><span class="line"></span><br><span class="line"><span class="meta">global</span> _start	<span class="comment">; 导出 _start</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">_start:</span>	<span class="comment">; 跳到这里来的时候，我们假设 gs 指向显存</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ah</span>, <span class="number">0Fh</span>				<span class="comment">; 0000: 黑底    1111: 白字</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="string">'K'</span></span><br><span class="line">	<span class="keyword">mov</span>	[<span class="built_in">gs</span>:((<span class="number">80</span> * <span class="number">1</span> + <span class="number">39</span>) * <span class="number">2</span>)], <span class="built_in">ax</span>	<span class="comment">; 屏幕第 1 行, 第 39 列。</span></span><br><span class="line">	<span class="keyword">jmp</span>	$</span><br></pre></td></tr></table></figure></p>
<p>显示字符时涉及内存操作，所以用到GDT，我们假设在Loader中段寄存器gs已经指向显存的开始。<br>运行结果如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180228/lg3dK8hff6.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/" itemprop="url">《ORANGE-s-一个操作系统实现》保护模式（2-4）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-27T10:29:00+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/" class="cy_cmt_count" data-xid="2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/02/27/《ORANGE-s-一个操作系统实现》保护模式（2-4）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》保护模式（2-4）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="突破512字节的限制"><a href="#突破512字节的限制" class="headerlink" title="突破512字节的限制"></a>突破512字节的限制</h1><p>前面我们的工作是完成了一个简陋的引导扇区，虽然感觉没做啥，但是我们实际上积累了很多代码，熟悉了保护模式。并且对存储管理、特权级控制等有了一个整体的认识<br>。下面，我们要想办法将自己的OS进入到保护模式，虽然进入保护模式不难，但是总会收到引导扇区512字节的限制，所以下面，我们再建立一个文件，将其通过引导扇区加载入内存，然后将控制权交给它。<br>首先，我们先理清楚一个问题，是不是被引导扇区加载到内存的就是操作系统的内核呢，我们先看看一个操作系统从开机到开始运行要经过一个怎样的过程：引导-&gt;加载内核入内存-&gt;跳入保护模式-&gt;开始执行内核。<br>所以，很明显，在内核开始执行前，不仅仅要加载内核，还有跳入保护模式等等，而这些工作都由引导扇区来做，很有可能不止512字节，所以我们把这个过程交给叫做Loader的模块来做。引导扇区负责把Loader加载到内存，并把控制权交给它，然后其他工作都由Loader来做，而它就没有512字节的限制了。</p>
<h2 id="FAT12"><a href="#FAT12" class="headerlink" title="FAT12"></a>FAT12</h2><p>FAT12是DOS时代就开始使用的文件系统，直到现在还在使用。几乎所有的文件系统都会把磁盘划分为若干层次（扇区：磁盘上的最小数据单元；簇：一个或者多个扇区；分区：通常指整个文件系统）以方便组织和管理，所以我们将软盘做成FAT12格式，以方便Kernel的操作。<br>引导扇区是整个软盘的第0个扇区，在这个扇区中有一个很重要的数据结构叫做BPB(BIOS Parameter Block)，引导扇区的格式如下图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/bmEkJIldf9.png?imageslim" alt="mark"><br>其中，名称以BPB开头的域输入BPB,以BS_开头的域只是引导扇区的一部分。以下是整个软盘的结构图：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/L924A4fH0k.png?imageslim" alt="mark"><br>接下来，我们试着把Loader复制到软盘上，并引导扇区找到并加载它。为简单起见，我们规定Loader只能放在根目录中，而根目录信息存放在FAT2后面的根目录区中。所以先研究根目录区。<br>根目录区位于第二个FAT表之后，开始的扇区号为19，它有若干个目录条目组成，条目最多有BPB_RootEntCnt个。由于根目录的大小依赖BPB_RootEntCnt的，所以长度不固定。<br>根目录区中的条目格式：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/k4Kh5dIHg9.png?imageslim" alt="mark"><br>当我们寻找Loader时，只要发现文件名正确就认为它是我们要找的那一个文件。其中最重要的信息是DIR_FstClus，即文件开始簇号，它会告诉我们文件存放在磁盘的什么位置，从而让我们可以找到它。由于一簇只包含一个扇区，所以简化起见，下面都用扇区来替代簇。，需要注意的是，数据区的第一个簇号是2。所以，我们必须计算根目录区所占的扇区数才能知道数据区的第一个簇在哪里。假设根目录区总共有RootDirSectors个扇区，则有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RootDirSectors = ((BPB_RootEntCnt*32)+(BPB_BytsPerSec-1))/BPB_BytsPerSec</span><br></pre></td></tr></table></figure>
<p>有了以上公式，可以通过根目录区找到文件并看到内容，而FAT的作用在于，如果文件大于512字节，我们需要FAT表来找到所有的簇。</p>
<h2 id="DOS可以识别的引导盘"><a href="#DOS可以识别的引导盘" class="headerlink" title="DOS可以识别的引导盘"></a>DOS可以识别的引导盘</h2><p>既然引导扇区需要有BPB等头信息才能被微软识别，我们就先加上它，让程序开头变成下面的形式：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">jmp </span><span class="keyword">short </span>LABEL_START		<span class="comment">; Start to boot.</span></span><br><span class="line">	<span class="keyword">nop	</span>			<span class="comment">; 这个 nop 不可少</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">; 下面是 FAT12 磁盘的头</span></span><br><span class="line">	<span class="keyword">BS_OEMName	</span>DB <span class="string">'ForrestY'</span>	<span class="comment">; OEM String, 必须 8 个字节</span></span><br><span class="line">	<span class="keyword">BPB_BytsPerSec	</span>DW <span class="number">512</span>		<span class="comment">; 每扇区字节数</span></span><br><span class="line">	<span class="keyword">BPB_SecPerClus	</span>DB <span class="number">1</span>		<span class="comment">; 每簇多少扇区</span></span><br><span class="line">	<span class="keyword">BPB_RsvdSecCnt	</span>DW <span class="number">1</span>		<span class="comment">; Boot 记录占用多少扇区</span></span><br><span class="line">	<span class="keyword">BPB_NumFATs	</span>DB <span class="number">2</span>		<span class="comment">; 共有多少 FAT 表</span></span><br><span class="line">	<span class="keyword">BPB_RootEntCnt	</span>DW <span class="number">224</span>		<span class="comment">; 根目录文件数最大值</span></span><br><span class="line">	<span class="keyword">BPB_TotSec16	</span>DW <span class="number">2880</span>		<span class="comment">; 逻辑扇区总数</span></span><br><span class="line">	<span class="keyword">BPB_Media	</span>DB <span class="number">0xF0</span>		<span class="comment">; 媒体描述符</span></span><br><span class="line">	<span class="keyword">BPB_FATSz16	</span>DW <span class="number">9</span>		<span class="comment">; 每FAT扇区数</span></span><br><span class="line">	<span class="keyword">BPB_SecPerTrk	</span>DW <span class="number">18</span>		<span class="comment">; 每磁道扇区数</span></span><br><span class="line">	<span class="keyword">BPB_NumHeads	</span>DW <span class="number">2</span>		<span class="comment">; 磁头数(面数)</span></span><br><span class="line">	<span class="keyword">BPB_HiddSec	</span>DD <span class="number">0</span>		<span class="comment">; 隐藏扇区数</span></span><br><span class="line">	<span class="keyword">BPB_TotSec32	</span>DD <span class="number">0</span>		<span class="comment">; wTotalSectorCount为0时这个值记录扇区数</span></span><br><span class="line">	<span class="keyword">BS_DrvNum	</span>DB <span class="number">0</span>		<span class="comment">; 中断 13 的驱动器号</span></span><br><span class="line">	<span class="keyword">BS_Reserved1	</span>DB <span class="number">0</span>		<span class="comment">; 未使用</span></span><br><span class="line">	<span class="keyword">BS_BootSig	</span>DB <span class="number">29</span>h		<span class="comment">; 扩展引导标记 (29h)</span></span><br><span class="line">	<span class="keyword">BS_VolID	</span>DD <span class="number">0</span>		<span class="comment">; 卷序列号</span></span><br><span class="line">	<span class="keyword">BS_VolLab	</span>DB <span class="string">'OrangeS0.02'</span><span class="comment">; 卷标, 必须 11 个字节</span></span><br><span class="line">	<span class="keyword">BS_FileSysType	</span>DB <span class="string">'FAT12   '</span>	<span class="comment">; 文件系统类型, 必须 8个字节</span></span><br></pre></td></tr></table></figure></p>
<p>把生成的Boot.bin写入磁盘引导扇区，运行的效果没有变。说明我们现在的软盘已经能被DOS以及Linux识别了，我们已经可以方便地往上添加或删除文件了。</p>
<h2 id="一个最简单的Loader"><a href="#一个最简单的Loader" class="headerlink" title="一个最简单的Loader"></a>一个最简单的Loader</h2><p>我们先写一个最小的，让其显示一个字符，然后进入死循环。<br>新建一个loader.asm，其代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">org	<span class="number">0100h</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="number">0B800h</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">gs</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ah</span>, <span class="number">0Fh</span>				<span class="comment">; 0000: 黑底    1111: 白字</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="string">'L'</span></span><br><span class="line">	<span class="keyword">mov</span>	[<span class="built_in">gs</span>:((<span class="number">80</span> * <span class="number">0</span> + <span class="number">39</span>) * <span class="number">2</span>)], <span class="built_in">ax</span>	<span class="comment">; 屏幕第 0 行, 第 39 列。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">jmp</span>	$				<span class="comment">; 到此停住</span></span><br></pre></td></tr></table></figure></p>
<p>我们将其编译,命令如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nasm</span> <span class="selector-tag">loader</span><span class="selector-class">.asm</span> <span class="selector-tag">-o</span> <span class="selector-tag">loader</span><span class="selector-class">.bin</span></span><br></pre></td></tr></table></figure></p>
<p>为了以后扩展不出问题，我们将编译后的二进制文件放在某个段内偏移0x100的位置。</p>
<h2 id="加载Loader如内存"><a href="#加载Loader如内存" class="headerlink" title="加载Loader如内存"></a>加载Loader如内存</h2><p>要加载一个文件如内存，免不了要读软盘，这时就要用到BIOS中断int 13h。它的用法如下：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/hfIaF1Jjl8.png?imageslim" alt="mark">。<br>从上可知，中断需要的参数不是原来提到的从第0扇区开始的扇区号，而是柱面号、磁头号以及在当前柱面上的扇区号3个分量，所以需要我们自己来转换一下。对于1.44MB的软盘来说，总共有两面，每面80个磁道，每个磁道有18个扇区。下面的公式就是软盘容量的由来：<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">2 </span>x <span class="number">80</span> x <span class="number">18</span> x <span class="number">512</span> =<span class="number">1.44</span>MB</span><br></pre></td></tr></table></figure></p>
<p>于是，磁头号、柱面号和起始扇区号可以用下图方法来计算：<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/ifaIbHjIF9.png?imageslim" alt="mark"><br>下面，我们先写一个读软盘区的函数：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">push</span>	<span class="built_in">bp</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bp</span>, <span class="built_in">sp</span></span><br><span class="line">	<span class="keyword">sub</span>	<span class="built_in">esp</span>, <span class="number">2</span> <span class="comment">; 辟出两个字节的堆栈区域保存要读的扇区数: byte [bp-2]</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">byte</span> [<span class="built_in">bp</span>-<span class="number">2</span>], <span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">push</span>	<span class="built_in">bx</span>			<span class="comment">; 保存 bx</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bl</span>, [BPB_SecPerTrk]	<span class="comment">; bl: 除数</span></span><br><span class="line">	<span class="keyword">div</span>	<span class="built_in">bl</span>			<span class="comment">; y 在 al 中, z 在 ah 中</span></span><br><span class="line">	<span class="keyword">inc</span>	<span class="number">ah</span>			<span class="comment">; z ++</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">ah</span>			<span class="comment">; cl &lt;- 起始扇区号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="built_in">al</span>			<span class="comment">; dh &lt;- y</span></span><br><span class="line">	<span class="keyword">shr</span>	<span class="built_in">al</span>, <span class="number">1</span>			<span class="comment">; y &gt;&gt; 1 (y/BPB_NumHeads)</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ch</span>, <span class="built_in">al</span>			<span class="comment">; ch &lt;- 柱面号</span></span><br><span class="line">	<span class="keyword">and</span>	<span class="number">dh</span>, <span class="number">1</span>			<span class="comment">; dh &amp; 1 = 磁头号</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bx</span>			<span class="comment">; 恢复 bx</span></span><br><span class="line">	<span class="comment">; 至此, "柱面号, 起始扇区, 磁头号" 全部得到</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dl</span>, [BS_DrvNum]		<span class="comment">; 驱动器号 (0 表示 A 盘)</span></span><br><span class="line"><span class="symbol">.GoOnReading:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">ah</span>, <span class="number">2</span>			<span class="comment">; 读</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">al</span>, <span class="built_in">byte</span> [<span class="built_in">bp</span>-<span class="number">2</span>]		<span class="comment">; 读 al 个扇区</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">13h</span></span><br><span class="line">	<span class="keyword">jc</span>	.GoOnReading		<span class="comment">; 如果读取错误 CF 会被置为 1, </span></span><br><span class="line">					<span class="comment">; 这时就不停地读, 直到正确为止</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">esp</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">pop</span>	<span class="built_in">bp</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">ret</span></span><br></pre></td></tr></table></figure></p>
<p>因为这段代码中用到了堆栈，要在程序开头初始化ss和esp<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BaseOfStack		<span class="built_in">equ</span>	<span class="number">07c00h</span>	<span class="comment">; 堆栈基地址(栈底, 从这个位置向低地址生长)</span></span><br><span class="line">....</span><br><span class="line"><span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">sp</span>, BaseOfStack</span><br></pre></td></tr></table></figure></p>
<p>读扇区的函数写好了，下面我们就开始在软盘中寻找Loader.bin<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">xor</span>	<span class="number">ah</span>, <span class="number">ah</span>	<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">xor</span>	<span class="built_in">dl</span>, <span class="built_in">dl</span>	<span class="comment">;  |  软驱复位</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">13h</span>	<span class="comment">; /</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">; 下面在 A 盘的根目录寻找 LOADER.BIN</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">word</span> [wSectorNo], SectorNoOfRootDirectory</span><br><span class="line"><span class="symbol">LABEL_SEARCH_IN_ROOT_DIR_BEGIN:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">word</span> [wRootDirSizeForLoop], <span class="number">0</span>	<span class="comment">;  `. 判断根目录区是不是已经读完</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_NO_LOADERBIN		<span class="comment">;  /  如果读完表示没有找到 LOADER.BIN</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">word</span> [wRootDirSizeForLoop]	<span class="comment">; /</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, BaseOfLoader</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">es</span>, <span class="built_in">ax</span>			<span class="comment">; es &lt;- BaseOfLoader</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">bx</span>, OffsetOfLoader	<span class="comment">; bx &lt;- OffsetOfLoader</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, [wSectorNo]		<span class="comment">; ax &lt;- Root Directory 中的某 Sector 号</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cl</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">call</span>	ReadSector</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">si</span>, LoaderFileName	<span class="comment">; ds:si -&gt; "LOADER  BIN"</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">di</span>, OffsetOfLoader	<span class="comment">; es:di -&gt; BaseOfLoader:0100</span></span><br><span class="line">	<span class="keyword">cld</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">dx</span>, <span class="number">10h</span></span><br><span class="line"><span class="symbol">LABEL_SEARCH_FOR_LOADERBIN:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">dx</span>, <span class="number">0</span>				   <span class="comment">; `. 循环次数控制,</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_GOTO_NEXT_SECTOR_IN_ROOT_DIR <span class="comment">;  / 如果已经读完了一个 Sector,</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">dx</span>				   <span class="comment">; /  就跳到下一个 Sector</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">cx</span>, <span class="number">11</span></span><br><span class="line"><span class="symbol">LABEL_CMP_FILENAME:</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">cx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">	jz	LABEL</span>_FILENAME_FOUND	<span class="comment">; 如果比较了 11 个字符都相等, 表示找到</span></span><br><span class="line">	<span class="keyword">dec</span>	<span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">lodsb</span>				<span class="comment">; ds:si -&gt; al</span></span><br><span class="line">	<span class="keyword">cmp</span>	<span class="built_in">al</span>, <span class="built_in">byte</span> [<span class="built_in">es</span>:<span class="built_in">di</span>]</span><br><span class="line"><span class="symbol">	jz	LABEL</span>_GO_ON</span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_DIFFERENT		<span class="comment">; 只要发现不一样的字符就表明本 DirectoryEntry</span></span><br><span class="line">					<span class="comment">; 不是我们要找的 LOADER.BIN</span></span><br><span class="line"><span class="symbol">LABEL_GO_ON:</span></span><br><span class="line">	<span class="keyword">inc</span>	<span class="built_in">di</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_CMP_FILENAME	<span class="comment">; 继续循环</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_DIFFERENT:</span></span><br><span class="line">	<span class="keyword">and</span>	<span class="built_in">di</span>, <span class="number">0FFE0h</span>		<span class="comment">; else `. di &amp;= E0 为了让它指向本条目开头</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">di</span>, <span class="number">20h</span>			<span class="comment">;       |</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">si</span>, LoaderFileName	<span class="comment">;       | di += 20h  下一个目录条目</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_SEARCH_FOR_LOADERBIN<span class="comment">;    /</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_GOTO_NEXT_SECTOR_IN_ROOT_DIR:</span></span><br><span class="line">	<span class="keyword">add</span>	<span class="built_in">word</span> [wSectorNo], <span class="number">1</span></span><br><span class="line"><span class="symbol">	jmp	LABEL</span>_SEARCH_IN_ROOT_DIR_BEGIN</span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_NO_LOADERBIN:</span></span><br><span class="line">	<span class="keyword">mov</span>	<span class="number">dh</span>, <span class="number">2</span>			<span class="comment">; "No LOADER."</span></span><br><span class="line">	<span class="keyword">call</span>	DispStr			<span class="comment">; 显示字符串</span></span><br><span class="line">%ifdef	_BOOT_DEBUG_</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">ax</span>, <span class="number">4c00h</span>		<span class="comment">; `.</span></span><br><span class="line">	<span class="keyword">int</span>	<span class="number">21h</span>			<span class="comment">; /  没有找到 LOADER.BIN, 回到 DOS</span></span><br><span class="line"><span class="meta">%else</span></span><br><span class="line">	<span class="keyword">jmp</span>	$			<span class="comment">; 没有找到 LOADER.BIN, 死循环在这里</span></span><br><span class="line"><span class="meta">%endif</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LABEL_FILENAME_FOUND:</span>			<span class="comment">; 找到 LOADER.BIN 后便来到这里继续</span></span><br><span class="line">	<span class="keyword">jmp</span>	$			<span class="comment">; 代码暂时停在这里</span></span><br></pre></td></tr></table></figure></p>
<p>这段代码就是遍历根目录区所有的扇区，将每一个扇区加载入内存，然后从中寻找文件名为Loader.bin的条目，直到找到为止。找到的那一刻，es:di是指向条目中字母N后面的那个字符。<br>接着我们编译出boot.bin<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nasm</span> <span class="selector-tag">boot</span><span class="selector-class">.asm</span> <span class="selector-tag">-o</span> <span class="selector-tag">boot</span><span class="selector-class">.bin</span></span><br></pre></td></tr></table></figure></p>
<p>,然后在bximage生成一个软盘映像，然后在Linux下输入命令：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nasm loader<span class="selector-class">.asm</span> -o loader.bin</span><br><span class="line"><span class="selector-tag">dd</span> <span class="keyword">if</span>=boot<span class="selector-class">.bin</span> of=<span class="selector-tag">a</span><span class="selector-class">.img</span> bs=<span class="number">512</span> count=<span class="number">1</span> conv=notrunc</span><br><span class="line">sudo mount -o loop <span class="selector-tag">a</span><span class="selector-class">.img</span> /mnt/floppy</span><br><span class="line">sudo cp loader<span class="selector-class">.bin</span> /mnt/floppy/ -v </span><br><span class="line">sudo umount /mnt/floppy</span><br></pre></td></tr></table></figure></p>
<h2 id="向Loader交出控制权"><a href="#向Loader交出控制权" class="headerlink" title="向Loader交出控制权"></a>向Loader交出控制权</h2><p>上面代码调试通过后，我i门就已经成功的将Loader加载入内存了，接着我们加上一个跳转。开始执行Loader<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">jmp	</span><span class="keyword">BaseOfLoader:OffsetOfLoader	</span><span class="comment">; 这一句正式跳转到已加载到内</span></span><br><span class="line">						<span class="comment">; 存中的 LOADER.BIN 的开始处，</span></span><br><span class="line">						<span class="comment">; 开始执行 LOADER.BIN 的代码。</span></span><br><span class="line">						<span class="comment">; Boot Sector 的使命到此结束。</span></span><br></pre></td></tr></table></figure></p>
<p>最后的结果如下<br><img src="http://p29pmm8g4.bkt.clouddn.com/blog/180227/2icjEELJIa.png?imageslim" alt="mark"></p>
<h1 id="保护下的“操作系统”"><a href="#保护下的“操作系统”" class="headerlink" title="保护下的“操作系统”"></a>保护下的“操作系统”</h1><p>为了让自己的操作系统内核至少应该可以在Linux下用GCC编译链接，所以我们假设已经有了一个内核，Loader肯定要加载它乳内存，而且内核开始执行对的时候肯定已经在保护模式下了，所以Loader要做的只要有两件事：</p>
<ul>
<li>加载内核如内存</li>
<li>跳入保护模式<br>将来的内核是在Linux下编译链接出的ELF格式文件，直接放进内存肯定不行，下一章就会开始研究ELF格式。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/" itemprop="url">财富之路-2018最容易赚钱的调查问卷平台</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T21:36:18+08:00">
                2018-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/财富之路/" itemprop="url" rel="index">
                    <span itemprop="name">财富之路</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/" class="cy_cmt_count" data-xid="2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/02/25/财富之路-2018最容易赚钱的调查问卷平台/" class="leancloud_visitors" data-flag-title="财富之路-2018最容易赚钱的调查问卷平台">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="91问问调查"><a href="#91问问调查" class="headerlink" title="91问问调查"></a>91问问调查</h1><p><a href="https://www.91wenwen.net/event/invite/hn1XX9NE0Ks%253D" target="_blank" rel="noopener">https://www.91wenwen.net/event/invite/hn1XX9NE0Ks%253D</a></p>
<pre><code>1、注册送积分。注册的时候送50积分=0.5元，等你完善个人信息的时候再送200积分=2.5元。

2、调查赚钱。登陆账户后，进入调查中心，里面有适合你的调查问卷，认真参与，即可获得奖励。每参加一次调查，获得2-10元。

3、有奖出题。参加快速问答（也就是投票）的设计，设计的问答被网站选用即可获取200积分
</code></pre><h1 id="投吧"><a href="#投吧" class="headerlink" title="投吧"></a>投吧</h1><p><a href="http://www.votebar.com/r.aspx?r=572819231769001075" target="_blank" rel="noopener">http://www.votebar.com/r.aspx?r=572819231769001075</a></p>
<p>老牌网站，操作简单，内容丰富，成功率高，二十四小时更新，奖励会即时到账户里，满10元可提现；每天签到就有奖，最大的缺点是有时有点卡，一旦出现卡顿，成功机率就会下降，这时就下线吧，等下次再答。这个网站是我的最爱，因为第一个注册的就是它，从开始到现在，已经过万字头。</p>
<h1 id="第一调查网"><a href="#第一调查网" class="headerlink" title="第一调查网"></a>第一调查网</h1><p><a href="http://www.1diaocha.com/user/Register.aspx?account=wcq19941215" target="_blank" rel="noopener">http://www.1diaocha.com/user/Register.aspx?account=wcq19941215</a><br>应该说国内最早开始的调查网站，内容丰富</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/" itemprop="url">《ORANGE-s-一个操作系统实现》保护模式（2-3）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T17:03:36+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/" class="cy_cmt_count" data-xid="2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》保护模式（2-3）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="页式存储"><a href="#页式存储" class="headerlink" title="页式存储"></a>页式存储</h1><p>说到这个，应该不会太陌生，但是对它可能值停留在理论学习阶段，没法像数据结构那样，理性的认识，下面我们先从几个问题出发</p>
<ul>
<li>什么叫做“页”<br>所谓“页”，就是一块内存，在80386中，页的大小是固定的4096字节。而后来，页的大小还可以是2MB或者4MB，并且可以访问多于4GB的内存。</li>
<li>逻辑地址、线性地址、物理地址<br>在未打开分页机制时，线性地址等同于物理地址。当分页开启时，分段机制将逻辑地址转换成线性地址，然后在通过分页机制变为物理地址。</li>
<li>为什么分页
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/01/24/《ORANGE-s-一个操作系统实现》保护模式（2-3）/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wcqwolflow.com/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王超群">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wang的宝库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/" itemprop="url">《ORANGE-s-一个操作系统实现》保护模式（2-2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-20T15:27:03+08:00">
                2018-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/ORANGE-s的学习/" itemprop="url" rel="index">
                    <span itemprop="name">ORANGE's的学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://www.wcqwolflow.com/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/" class="cy_cmt_count" data-xid="2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          
             <span id="/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/" class="leancloud_visitors" data-flag-title="《ORANGE-s-一个操作系统实现》保护模式（2-2）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="保护模式进阶"><a href="#保护模式进阶" class="headerlink" title="保护模式进阶"></a>保护模式进阶</h1><p>前面我们学习了保护模式，对它的一个整体有了了解，其中突出讲解了保护模式下的强大寻址能力，但是保护模式不仅仅有这个优点，下面我们继续学习保护模式。</p>
<h1 id="1-补个坑"><a href="#1-补个坑" class="headerlink" title="1.补个坑"></a>1.补个坑</h1><p>前面我们还是把保护模式写在引导扇区，这就限制在了512字节，我们就借用DOS的引导扇区来解除这个限制。<br>首先，我们按照如下操作进行：</p>
<ul>
<li>到Bochs官网下载FreeDOs。解压后将其中的a.img复制到工作目录下，并改名为freedos.img。</li>
<li>然后用bximage深层一个软盘映像，命名为pm.img。</li>
<li><p>在修改bochsrc，为如下：</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/01/20/《ORANGE-s-一个操作系统实现》保护模式（2-2）/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p29pmm8g4.bkt.clouddn.com/blog/180125/jegddfAhH2.jpg"
                alt="王超群" />
            
              <p class="site-author-name" itemprop="name">王超群</p>
              <p class="site-description motion-element" itemprop="description">生命不息，学习不停</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wcq19941215/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wcq19941215@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope-o"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://coding.net/u/wcq19941215/p/wcq19941215/git" target="_blank" title="Coding">
                      
                        <i class="fa fa-fw fa-gg"></i>Coding</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://qm.qq.com/cgi-bin/qm/qr?k=0f1-FOovagbwBUhH5vF14JlZLPFVdehl" target="_blank" title="QQ">
                      
                        <i class="fa fa-fw fa-qq"></i>QQ</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-star"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王超群</span>

  
</div>


  <div class="powered-by">
<i class="fa fa-user-md"></i>
<span id="busuanzi_container_site_pv">
  本站访客数:<span id="busuanzi_value_site_pv">
  </span>
  <span class="post-meta-divider">|</span>
  <span>
  Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
  </span>
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
  
</span>
</div>

  <span class="post-meta-divider">|</span>

  <div class="powered-by">
  由 <a class="theme-link"  href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  




  
    <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cytpdOqGo"></script>
  









  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("ALlRmsSvFBUrO1gENKJa4bBM-gzGzoHsz", "PqFmK6RFXdopkhg9og0VH5Wt");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
</body>
</html>
